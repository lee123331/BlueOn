<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê´€ë¦¬ì ì£¼ë¬¸ ê´€ë¦¬ | BlueOn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body {
      margin:0;
      font-family:"Noto Sans KR",sans-serif;
      background:#f5f6fa;
    }
    header {
      background:#111827;
      color:#fff;
      padding:18px 30px;
      font-size:20px;
      font-weight:800;
    }
    .wrap {
      max-width:1100px;
      margin:30px auto;
      padding:0 20px;
    }
    h2 {
      margin-bottom:16px;
    }
    .notice {
      display:none;
      background:#fff3cd;
      border:1px solid #ffeeba;
      padding:14px 18px;
      border-radius:10px;
      font-weight:700;
      margin-bottom:20px;
    }
    table {
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 6px 18px rgba(0,0,0,.05);
    }
    th, td {
      padding:14px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
      font-size:14px;
    }
    th {
      background:#f9fafb;
      font-weight:800;
    }
    tr:last-child td {
      border-bottom:none;
    }
    .status {
      font-weight:800;
    }
    .pending { color:#f59e0b; }
    .paid { color:#2563eb; }
    .btn {
      padding:8px 12px;
      border:none;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
    }
    .btn-confirm {
      background:#2563eb;
      color:#fff;
    }
    .btn-confirm:hover {
      background:#1e40af;
    }
  </style>
</head>
<body>

<header>BlueOn ê´€ë¦¬ì ì£¼ë¬¸ ê´€ë¦¬</header>

<div class="wrap">
  <h2>ì£¼ë¬¸ ëª©ë¡</h2>

  <!-- ğŸ”” ê´€ë¦¬ì ì‹¤ì‹œê°„ ì•Œë¦¼ -->
  <div id="adminNotice" class="notice"></div>

  <table>
    <thead>
      <tr>
        <th>ì£¼ë¬¸ë²ˆí˜¸</th>
        <th>ìœ ì €</th>
        <th>ì„œë¹„ìŠ¤</th>
        <th>ê¸ˆì•¡</th>
        <th>ìƒíƒœ</th>
        <th>ì²˜ë¦¬</th>
      </tr>
    </thead>
    <tbody id="orderBody"></tbody>
  </table>
</div>

<script>
const API = "https://blueon.up.railway.app";
const tbody = document.getElementById("orderBody");
const noticeBox = document.getElementById("adminNotice");

/* ===========================
   ğŸ”” í¬ë¡¬ ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
=========================== */
if ("Notification" in window && Notification.permission === "default") {
  Notification.requestPermission();
}

/* ===========================
   ğŸ”Œ ê´€ë¦¬ì Socket ì—°ê²°
=========================== */
const socket = io(API, {
  transports: ["websocket"],
  credentials: true
});

/* =====================================================
   ğŸ”” ì‹ ê·œ ì£¼ë¬¸ ì•Œë¦¼ (orders/create â†’ notice:new)
===================================================== */
socket.on("notice:new", (data) => {
  if (data.type !== "admin") return;

  noticeBox.textContent = data.message;
  noticeBox.style.display = "block";

  if (Notification.permission === "granted") {
    new Notification("ğŸ›’ ì‹ ê·œ ì£¼ë¬¸ ë°œìƒ", {
      body: data.message
    });
  }

  loadOrders();
});

/* =====================================================
   ğŸ’° ì…ê¸ˆ ìš”ì²­ ì•Œë¦¼ (orders/notify-deposit)
===================================================== */
socket.on("admin:deposit-notify", (data) => {
  noticeBox.textContent = data.message;
  noticeBox.style.display = "block";

  if (Notification.permission === "granted") {
    new Notification("ğŸ’° ì…ê¸ˆ ìš”ì²­ ë„ì°©", {
      body: data.message
    });
  }

  loadOrders();
});

/* ===========================
   ğŸ“¦ ì£¼ë¬¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
=========================== */
async function loadOrders() {
  try {
    const res = await fetch("/admin/orders", {
      credentials: "include"
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();

    if (!data.success) {
      alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      location.href = "/";
      return;
    }

    tbody.innerHTML = "";

    data.orders.forEach(o => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${o.order_id}</td>
        <td>${o.buyer_name || "ì•Œ ìˆ˜ ì—†ìŒ"}</td>
        <td>${o.service_title || "-"}</td>
        <td>${Number(o.price || 0).toLocaleString()}ì›</td>
        <td class="status ${o.status}">${o.status}</td>
        <td>
          ${
            o.status === "pending"
              ? `<button class="btn btn-confirm"
                   onclick="confirmPayment('${o.order_id}')">
                   ì…ê¸ˆ í™•ì¸
                 </button>`
              : "-"
          }
        </td>
      `;

      tbody.appendChild(tr);
    });

  } catch (err) {
    console.error("âŒ ì£¼ë¬¸ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", err);
    alert("ì£¼ë¬¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

/* ===========================
   âœ… ì…ê¸ˆ í™•ì¸ ì²˜ë¦¬
=========================== */
async function confirmPayment(orderId) {
  if (!orderId) return;

  if (!confirm(`ì£¼ë¬¸ë²ˆí˜¸ ${orderId}ì˜ ì…ê¸ˆì„ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

  try {
    const res = await fetch("/admin/order/confirm", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ orderId })
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();

    if (!data.success) {
      alert(data.message || "ì…ê¸ˆ í™•ì¸ ì‹¤íŒ¨");
      return;
    }

    alert("ì…ê¸ˆ í™•ì¸ ì™„ë£Œ");
    loadOrders();

  } catch (err) {
    console.error("âŒ ì…ê¸ˆ í™•ì¸ ì˜¤ë¥˜:", err);
    alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ì…ê¸ˆ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  }
}

/* ===========================
   ì´ˆê¸° ë¡œë”©
=========================== */
loadOrders();
</script>

</body>
</html>
