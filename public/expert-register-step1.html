<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BlueOn | 전문가 등록 – 전문가 소개</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --primary:#0056ff;

  --bg:#ffffff;
  --white:#ffffff;

  --text-dark:#111827;
  --text-gray:#6b7280;
  --line:#e5e7eb;
}

*{margin:0;padding:0;box-sizing:border-box;}

body{
  font-family:"Noto Sans KR",sans-serif;
  background:var(--bg);
  color:var(--text-dark);
}

/* 전체 레이아웃 */
.wrapper{
  background: var(--white);
  max-width:1400px;
  margin:0 auto;
  padding:40px 30px;
  display:flex;
  gap:40px;
}

/* ========== ASIDE ========== */
aside{
  width:260px;
  background:var(--white);
  border:1px solid var(--line);
  padding:25px 20px;
  border-radius:12px;
  box-shadow:0 5px 18px rgba(0,0,0,0.04);
}

.aside-title{
  font-size:18px;
  font-weight:700;
  margin-bottom:20px;
  color:var(--primary);
}

.menu-item{
  padding:12px 12px;
  border-radius:8px;
  margin-bottom:8px;
  font-size:15px;
  cursor:pointer;
  transition:0.2s;
}

.menu-item:hover{
  background:#eef3ff;
}

.menu-item.active{
  background:var(--primary);
  color:#fff;
  font-weight:600;
}

/* ========== CONTENT ========== */
section.content{
  flex:1;
  background:var(--white);
  border:1px solid var(--line);
  border-radius:12px;
  padding:40px 50px 80px; /* 아래쪽 여백 넉넉하게 */
  box-shadow:0 6px 18px rgba(0,0,0,0.04);
}

section h2{
  font-size:24px;
  font-weight:800;
  margin-bottom:30px;
}

/* 프로필 + 닉네임 UI */
.profile-row{
  display:flex;
  align-items:flex-start;
  gap:40px;
  margin-bottom:26px;
}

.profile-avatar{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
}

.profile-avatar img{
  width:110px;
  height:110px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid #e5e5e5;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}

.profile-btn{
  padding:7px 14px;
  border-radius:7px;
  background:#f3f4f6;
  border:1px solid var(--line);
  cursor:pointer;
  font-size:13px;
  font-weight:600;
}
.profile-btn:hover{
  background:#e9efff;
  border-color:#c7d6ff;
}

/* 닉네임 라인 */
.nickname-row{
  display:flex;
  align-items:center;
  gap:28px;
  flex:1;
}

/* 왼쪽 라벨 */
.nickname-label{
  width:80px;
  font-size:15px;
  font-weight:700;
}

/* 입력 영역 */
.nickname-input-box{
  flex:1;
  display:flex;
  flex-direction:column;
  margin-top:30px;
}

/* 닉네임 입력란 회색 배경 */
.nickname-input-box input{
  width:100%;
  padding:12px 14px;
  border-radius:8px;
  border:1px solid var(--line);
  font-size:15px;
  background:#f5f5f5;
  outline:none;
}

/* placeholder 진하게 */
#nicknameInput::placeholder{
  color:#6b7280;
  font-weight:600;
}

/* 포커스 시 테두리만 파란색 */
.nickname-input-box input:focus{
  border-color:var(--primary);
  background:#e4e2e2;
}

/* 상태 메시지 */
.status-msg{
  margin-top:5px;
  font-size:12px;
  min-height:14px;
}
.status-msg.ok{color:#16a34a;}
.status-msg.error{color:#ef4444;}

/* TIP */
.tip-box{
  background:#f5f7ff;
  border:1px solid #dbeafe;
  padding:16px 18px;
  border-radius:10px;
  font-size:13px;
  color:var(--text-gray);
  margin-bottom:26px;
}
.tip-box li{
  margin-left:18px;
  list-style:square;
}

/* 폼 공통 */
.form-group{
  position:static;
  overflow:visible;
  margin-bottom:25px;
}
.form-group label{
  font-weight:700;
  margin-bottom:8px;
  display:block;
}

/* 상세 자기소개 회색 배경 */
#introDetail{
  width:100%;
  padding:14px;
  border:1px solid var(--line);
  border-radius:8px;
  font-size:15px;
  background:#f5f5f5;
  outline:none;
}
#introDetail:focus{
  border-color:var(--primary);
}

/* ================================
   2단 카테고리 선택 UI
================================ */
.category-wrapper {
  display: flex;
  width: 100%;
  gap: 20px;
  align-items: stretch;
}


.category-left {
  width: 260px;
  border: 1px solid var(--line);
  border-radius: 10px;
  background: #fafafa;
  overflow-y: auto;
  height: 350px; /* 통일 */
}


.category-left-item {
  padding: 14px 16px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
  transition: 0.15s;
  font-size: 15px;
  font-weight: 500;
}

.category-left-item:hover {
  background: #eef3ff;
}

.category-left-item.active {
  background: var(--primary);
  color: #fff;
  font-weight: 700;
}

.category-right {
  flex: 1;
  border: 1px solid var(--line);
  border-radius: 10px;
  background: #fff;
  padding: 18px 20px;
  overflow-y: auto;
  height: 350px; /* 통일 */
}

.subcat-item {
  padding: 12px 14px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  margin-bottom: 10px;
  cursor: pointer;
  transition: 0.2s;
}

.subcat-item:hover {
  background: #f5f7ff;
  border-color: #c7d6ff;
}

.subcat-item.active {
  background: var(--primary);
  border-color: var(--primary);
  color: #fff;
  font-weight: 700;
}


/* 버튼 */
.next-button{
  margin-top:35px;
  padding:14px 36px;
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:10px;
  font-weight:700;
  font-size:16px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}
.next-button:hover{
  background:#0044cc;
}
/* 닉네임 경고 강조 효과 */
.status-msg.error {
  color: #ef4444;
  font-weight: 600;
  animation: shake 0.25s ease;
}

@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-3px); }
  50% { transform: translateX(3px); }
  75% { transform: translateX(-3px); }
  100% { transform: translateX(0); }
}

</style>
</head>

<body>

<div class="wrapper">

  <!-- ASIDE -->
  <aside>
    <div class="aside-title">전문가 등록</div>

    <div class="menu-item active" onclick="goStep('intro')">전문가 소개</div>
    <div class="menu-item" onclick="goStep('career')">경력 사항</div>
    <div class="menu-item" onclick="goStep('skill')">전문 역량 & 인증</div>
    <div class="menu-item" onclick="goStep('brand')">브랜드 스토리</div>
  </aside>

  <!-- CONTENT -->
  <section class="content">

    <h2>전문가 소개</h2>

    <!-- 프로필 + 닉네임 -->
    <div class="profile-row">

      <div class="profile-avatar">
        <img id="expertPreview" src="/assets/default_profile.png" alt="프로필 이미지">
        <input type="file" id="expertAvatar" accept="image/*" hidden>
        <button type="button" class="profile-btn" onclick="document.getElementById('expertAvatar').click()">프로필 변경</button>
      </div>

      <div class="nickname-row">
        <label for="nicknameInput" class="nickname-label">닉네임</label>
        <div class="nickname-input-box">
          <input id="nicknameInput" type="text" placeholder="닉네임 입력">
          <small id="nicknameStatus" class="status-msg"></small>
        </div>
      </div>

    </div>

    <!-- TIP -->
    <div class="tip-box">
      <ul>
        <li>닉네임은 최초 1회만 변경할 수 있습니다.</li>
        <li>특수문자, 공백, 과도한 광고성 문구는 사용이 제한될 수 있습니다.</li>
        <li>한글/영문/숫자만 사용할 수 있으며, 이메일 아이디 또는 비밀번호와 동일한 문자열은 사용이 불가능합니다.</li>
      </ul>
    </div>

    <!-- 상세 소개 -->
    <div class="form-group">
      <label for="introDetail">상세 자기소개</label>
      <textarea id="introDetail" rows="7" placeholder="전문가님의 경험, 작업 스타일, 고객과의 협업 방식 등을 자유롭게 작성해주세요."></textarea>
    </div>
<!-- 2단 카테고리 UI -->
<div class="form-group">
  <label>서비스 카테고리</label>

  <div class="category-wrapper">
    
    <!-- 왼쪽: 상위 카테고리 -->
    <div id="topCategoryBox" class="category-left"></div>

    <!-- 오른쪽: 하위 카테고리 -->
    <div id="subCategoryBox" class="category-right">
      <p style="color:var(--text-gray);">상위 카테고리를 먼저 선택하세요.</p>
    </div>

  </div>
</div>


    <button class="next-button" type="button" onclick="goNextStep()">
  다음 단계로 이동
</button>

  </section>

</div>
<script>
const API_URL = window.API_URL;


/* ===============================
   DOM 요소
================================ */
const nicknameInput = document.getElementById("nicknameInput");
const nicknameStatus = document.getElementById("nicknameStatus");
const introDetail = document.getElementById("introDetail");
const avatarInput = document.getElementById("expertAvatar");
const avatarPreview = document.getElementById("expertPreview");

const topBox = document.getElementById("topCategoryBox");
const subBox = document.getElementById("subCategoryBox");

/* ===============================
   카테고리 데이터 (전문가 Step1 최종)
================================ */

const categoryMap = {
  shop: [
    "스마트스토어 · 마켓 구축",
    "자사몰 구축",
    "랜딩페이지 제작",
    "홈페이지 제작",
    "쇼핑몰 UI/UX 개선",
    "쇼핑몰 기능 커스터마이징"
  ],

  detail: [
    "상세페이지 디자인",
    "상세페이지 기획",
    "배너 · 광고 이미지 디자인",
    "SNS 콘텐츠 디자인",
    "제품 촬영 연계"
  ],

  brand: [
    "로고 디자인",
    "브랜드 아이덴티티(BI·CI)",
    "브랜드 키비주얼 디자인",
    "브랜드 스토리텔링",
    "브랜드 가이드 제작"
  ],

  ux: [
    "UX 구조 설계",
    "전환율(CRO) 개선",
    "고객 여정 지도(CJM)",
    "사용자 경험 분석",
    "UI 개선 · 리디자인"
  ]
};

const topCategoryTitles = {
  shop: "쇼핑몰 · 웹 제작",
  detail: "콘텐츠 · 상세페이지 디자인",
  brand: "브랜드 디자인",
  ux: "전환율 개선 · UX/UI"
};


let selectedTop = "";
let selectedSub = "";

/* ===============================
   STEP1 저장 (로컬 + 서버)
================================ */
async function saveStep1({ syncServer = false } = {}) {
  const data = {
    nickname: nicknameInput.value || "",
    intro: introDetail.value || "",
    topCategory: selectedTop || "",
    subCategory: selectedSub || "",
    avatarUrl: avatarPreview.dataset.url || ""
  };

  // ✅ 로컬 저장
  localStorage.setItem("expert_step1", JSON.stringify(data));

  // ✅ 필요할 때만 서버 저장
  if (syncServer) {
    try {
      await fetch(`${API_URL}/expert/save-step`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ step: 1, data })
      });
    } catch (e) {
      console.warn("서버 저장 실패", e);
    }
  }
}

/* ===============================
   STEP1 불러오기
================================ */
function loadStep1() {
  const saved = localStorage.getItem("expert_step1");
  if (!saved) return;

  try {
    const data = JSON.parse(saved);
    nicknameInput.value = data.nickname || "";
    introDetail.value = data.intro || "";
    selectedTop = data.topCategory || "";
    selectedSub = data.subCategory || "";

    if (data.avatarUrl) {
      avatarPreview.src = data.avatarUrl;
      avatarPreview.dataset.url = data.avatarUrl;
    }
  } catch {}
}

/* ===============================
   카테고리 렌더링
================================ */
function renderTopCategories() {
  topBox.innerHTML = "";

  Object.keys(topCategoryTitles).forEach(key => {
    const div = document.createElement("div");
    div.className = "category-left-item";
    div.textContent = topCategoryTitles[key];
    if (selectedTop === key) div.classList.add("active");

    div.onclick = () => {
      selectedTop = key;
      selectedSub = "";
      renderTopCategories();
      renderSubCategories();
      saveStep1();
    };

    topBox.appendChild(div);
  });
}

function renderSubCategories() {
  subBox.innerHTML = "";

  if (!selectedTop) {
    subBox.innerHTML =
      "<p style='color:#6b7280;'>상위 카테고리를 선택하세요.</p>";
    return;
  }

  categoryMap[selectedTop].forEach(name => {
    const div = document.createElement("div");
    div.className = "subcat-item";
    div.textContent = name;
    if (selectedSub === name) div.classList.add("active");

    div.onclick = () => {
      selectedSub = name;
      renderSubCategories();
      saveStep1();
    };

    subBox.appendChild(div);
  });
}

/* ===============================
   닉네임 중복 체크 (최종 안정화)
   - server: available true/false 기준
   - debounce 400ms
   - input 이벤트 기반
================================ */

let nicknameValid = false;
let nicknameTimer = null;

nicknameInput.addEventListener("input", () => {
  const nickname = nicknameInput.value.trim();

  // 초기화
  nicknameStatus.className = "status-msg";
  nicknameStatus.textContent = "";
  nicknameValid = false;

  // 빈 값이면 검사 안 함
  if (!nickname) return;

  // 이전 타이머 제거
  clearTimeout(nicknameTimer);

  // 400ms 입력 멈추면 검사
  nicknameTimer = setTimeout(async () => {
    try {
      const res = await fetch(
        `${API_URL}/expert/check-nickname?nickname=${encodeURIComponent(nickname)}`,
        { credentials: "include" }
      );

      if (!res.ok) throw new Error("request failed");

      const data = await res.json();

      // ✅ 서버는 available 기준
      if (!data.available) {
        nicknameStatus.textContent = "이미 사용 중인 닉네임입니다.";
        nicknameStatus.classList.add("error");
        nicknameValid = false;
      } else {
        nicknameStatus.textContent = "사용 가능한 닉네임입니다.";
        nicknameStatus.classList.add("ok");
        nicknameValid = true;
      }

    } catch (err) {
      console.error("닉네임 체크 오류:", err);
      nicknameStatus.textContent = "닉네임 확인 실패";
      nicknameStatus.classList.add("error");
      nicknameValid = false;
    }
  }, 400);
});

/* ===============================
   아바타 업로드
================================ */
avatarInput.addEventListener("change", async () => {
  const file = avatarInput.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("avatar", file);

  try {
    const res = await fetch(`${API_URL}/expert/upload-avatar`, {
      method: "POST",
      credentials: "include",
      body: formData
    });
    const data = await res.json();

    if (data.success) {
      avatarPreview.src = data.url;
      avatarPreview.dataset.url = data.url;
      saveStep1();
    }
  } catch {
    alert("이미지 업로드 실패");
  }
});

/* ===============================
   입력 자동 저장 (로컬만)
================================ */
nicknameInput.addEventListener("input", () => saveStep1());
introDetail.addEventListener("input", () => saveStep1());

/* ===============================
   다음 단계 이동
================================ */
function goNextStep() {
  const nickname = nicknameInput.value.trim();

  // 1️⃣ 닉네임 입력 여부
  if (!nickname) {
    nicknameStatus.textContent = "닉네임을 입력해주세요.";
    nicknameStatus.className = "status-msg error";
    nicknameInput.focus();
    return;
  }

  // 2️⃣ 닉네임 중복 검사 여부
  if (!nicknameValid) {
    nicknameStatus.textContent = "닉네임 중복 여부를 확인해주세요.";
    nicknameStatus.className = "status-msg error";
    nicknameInput.focus();
    return;
  }

  // 3️⃣ 카테고리 선택 여부
  if (!selectedTop || !selectedSub) {
    alert("카테고리를 선택하세요."); // ← 이건 다음 단계에서 toast로 바꿔도 됨
    return;
  }

  // 4️⃣ 저장 + 다음 단계
  saveStep1({ syncServer: true });
  location.href = "/expert-register-step2.html";
}


/* ===============================
   전문가 등록 단계 이동
================================ */
function goStep(step) {
  const stepMap = {
    intro: "/expert-register-step1.html",
    career: "/expert-register-step2.html",
    skill: "/expert-register-step3.html",
    brand: "/expert-register-step4.html"
  };

  const target = stepMap[step];
  if (!target) return;

  // Step1 데이터 저장 (로컬)
  saveStep1();

  location.href = target;
}

/* ===============================
   초기 실행
================================ */
window.addEventListener("DOMContentLoaded", () => {
  loadStep1();
  renderTopCategories();
  renderSubCategories();
});
</script>



</body>
</html>