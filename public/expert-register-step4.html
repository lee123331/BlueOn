<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BlueOn | ì „ë¬¸ê°€ ë“±ë¡ â€“ ë¸Œëœë“œ ìŠ¤í† ë¦¬</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --primary:#0056ff;
  --bg:#ffffff;
  --white:#ffffff;
  --text-dark:#111827;
  --text-gray:#6b7280;
  --line:#e5e7eb;
}

*{margin:0;padding:0;box-sizing:border-box;}

body{
  font-family:"Noto Sans KR",sans-serif;
  background:var(--bg);
  color:var(--text-dark);
}

/* ì „ì²´ ë ˆì´ì•„ì›ƒ */
.wrapper{
  max-width:1400px;
  margin:0 auto;
  padding:40px 30px;
  display:flex;
  gap:40px;
}

/* ASIDE */
aside{
  width:260px;
  background:var(--white);
  border:1px solid var(--line);
  padding:25px 20px;
  border-radius:12px;
  box-shadow:0 5px 18px rgba(0,0,0,0.04);
}

.aside-title{
  font-size:18px;
  font-weight:700;
  margin-bottom:20px;
  color:var(--primary);
}

.menu-item{
  padding:12px 12px;
  border-radius:8px;
  margin-bottom:8px;
  font-size:15px;
  cursor:pointer;
  transition:0.2s;
}
.menu-item:hover{background:#eef3ff;}
.menu-item.active{
  background:var(--primary);
  color:#fff;
  font-weight:600;
}

/* CONTENT */
section.content{
  flex:1;
  background:var(--white);
  border:1px solid var(--line);
  border-radius:12px;
  padding:40px 50px;
  box-shadow:0 6px 18px rgba(0,0,0,0.04);
}

section h2{
  font-size:24px;
  font-weight:800;
  margin-bottom:30px;
}

/* ============================
   ì „ë¬¸ê°€ ìŠ¤í† ë¦¬ ì¹´ë“œ
============================ */
.story-card {
  width: 100%;
  background: #ffffff;
  border-radius: 14px;
  padding: 16px 20px;
  margin-bottom: 16px;
  border: 1px solid #eef0f3;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
  transition: 0.25s ease;
  cursor: pointer;
}
.story-card:hover {
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.07);
  border-color: #d9e2ff;
}
.story-title {
  font-size: 16px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.story-title .arrow {
  transition: transform 0.25s ease;
  font-size: 16px;
  opacity: 0.7;
}
.story-card.open .arrow {
  transform: rotate(180deg);
  opacity: 1;
}
.story-content {
  margin-top: 14px;
  display: none;
  animation: fadeSlide 0.22s ease forwards;
}
.story-card.open .story-content {
  display: block;
}

@keyframes fadeSlide {
  from { opacity: 0; transform: translateY(-6px); }
  to { opacity: 1; transform: translateY(0); }
}

.story-textarea {
  width: 100%;
  resize: none;
  padding: 12px 14px;
  border-radius: 10px;
  border: 1px solid #dee1e7;
  background: #f9fafc;
  font-size: 14px;
  min-height: 95px;
  line-height: 1.45;
  outline: none;
}
.story-textarea:focus {
  border-color: var(--primary);
  background: #ffffff;
  box-shadow: 0 0 0 3px rgba(0, 86, 255, 0.12);
}

/* ë²„íŠ¼ */
.finish-btn{
  margin-top:35px;
  width:100%;
  padding:14px;
  border-radius:10px;
  background:var(--primary);
  color:#fff;
  font-size:17px;
  font-weight:700;
  border:none;
  cursor:pointer;
}
.finish-btn:hover{background:#0044cc;}

.toast {
  position: fixed;
  top: 30px;
  right: 30px;
  min-width: 260px;
  max-width: 360px;
  padding: 14px 18px;
  background: #0056ff;
  color: #fff;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  z-index: 9999;
  opacity: 0;
  transform: translateY(-20px);
  pointer-events: none;
  transition: all 0.35s ease;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}
.toast.show {
  opacity: 1;
  transform: translateY(0);
}

.input-error {
  border-color: #ef4444 !important;
  background: #fff5f5 !important;
}
.input-ok {
  border-color: #22c55e !important;
  background: #f0fff4 !important;
}
</style>
</head>

<body>

<div class="wrapper">

<!-- ASIDE -->
<aside>
  <div class="aside-title">ì „ë¬¸ê°€ ë“±ë¡</div>

  <div class="menu-item" onclick="goStep('intro')">ì „ë¬¸ê°€ ì†Œê°œ</div>
  <div class="menu-item" onclick="goStep('career')">ê²½ë ¥ ì‚¬í•­</div>
  <div class="menu-item" onclick="goStep('skill')">ì „ë¬¸ ì—­ëŸ‰ & ì¸ì¦</div>
  <div class="menu-item active" onclick="goStep('brand')">ë¸Œëœë“œ ìŠ¤í† ë¦¬ & ê³„ì¢Œì •ë³´</div>
</aside>

<!-- CONTENT -->
<section class="content">

  <h2>ë¸Œëœë“œ ìŠ¤í† ë¦¬ & ê³„ì¢Œì •ë³´</h2>

  <!-- ì¹´ë“œ 1 -->
  <div class="story-card">
    <div class="story-title" onclick="toggleCard(this.parentElement)">
      <span>ì‘ì—… ì² í•™</span>
      <span class="arrow">â–¼</span>
    </div>
    <div class="story-content">
      <textarea id="story_work" class="story-textarea"
        placeholder="ì „ë¬¸ê°€ë‹˜ì˜ ì‘ì—… ì›ì¹™, ì¼í•˜ëŠ” ë°©ì‹ ë“±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
    </div>
  </div>

  <!-- ì¹´ë“œ 2 -->
  <div class="story-card">
    <div class="story-title" onclick="toggleCard(this.parentElement)">
      <span>ê³ ê° ì¼€ì–´ ë°©ì‹</span>
      <span class="arrow">â–¼</span>
    </div>
    <div class="story-content">
      <textarea id="story_care" class="story-textarea"
        placeholder="ê³ ê°ê³¼ì˜ ì†Œí†µ ë°©ì‹, í”„ë¡œì íŠ¸ ê´€ë¦¬ ë°©ì‹ ë“±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
    </div>
  </div>

  <!-- ì¹´ë“œ 3 -->
  <div class="story-card">
    <div class="story-title" onclick="toggleCard(this.parentElement)">
      <span>ë¸Œëœë“œ ë°©í–¥</span>
      <span class="arrow">â–¼</span>
    </div>
    <div class="story-content">
      <textarea id="story_brand" class="story-textarea"
        placeholder="ë¸Œëœë“œì˜ í•µì‹¬ ë°©í–¥ì„±, ì œê³µí•˜ëŠ” ê°€ì¹˜ ë“±ì„ ì‘ì„±í•˜ì„¸ìš”."></textarea>
    </div>
  </div>

  <!-- ì¹´ë“œ 4 -->
  <div class="story-card">
    <div class="story-title" onclick="toggleCard(this.parentElement)">
      <span>ì „ë¬¸ê°€ì˜ ëª©í‘œ</span>
      <span class="arrow">â–¼</span>
    </div>
    <div class="story-content">
      <textarea id="story_goal" class="story-textarea"
        placeholder="ì „ë¬¸ê°€ë¡œì„œì˜ ì¥ê¸°ì  ëª©í‘œì™€ ì„±ì¥ ë°©í–¥ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
    </div>
  </div>

 
<!-- STEP 5 â€“ ì •ì‚° ê³„ì¢Œ -->
<h2 style="margin-top:50px;">ì •ì‚° ê³„ì¢Œ ì •ë³´</h2>

<div class="story-card">
  <div class="story-title" onclick="toggleCard(this.parentElement)">
    <span>ì •ì‚° ê³„ì¢Œ ì…ë ¥</span>
    <span class="arrow">â–¼</span>
  </div>

  <div class="story-content">

    <label style="font-weight:600; margin-bottom:6px;">ì€í–‰ëª…</label>
    <input 
      id="bankName" 
      type="text" 
      placeholder="ì˜ˆ: ì¹´ì¹´ì˜¤ë±…í¬"
      class="story-textarea"
      style="height:45px;"
    >

    <label style="font-weight:600; margin-top:16px; margin-bottom:6px;">ì˜ˆê¸ˆì£¼</label>
    <input 
      id="accountHolder" 
      type="text" 
      placeholder="ì˜ˆ: í™ê¸¸ë™"
      class="story-textarea"
      style="height:45px;"
    >

    <!-- ê³„ì¢Œë²ˆí˜¸ -->
    <label style="font-weight:600; margin-top:16px; margin-bottom:6px;">ê³„ì¢Œë²ˆí˜¸</label>

    <div class="input-wrapper" style="position: relative; width: 100%;">
      <input 
        id="accountNumber" 
        type="text" 
        placeholder="ì˜ˆ: 3333021234567"
        class="story-textarea"
        style="height:45px;"
      >
      <span class="input-hint" 
            style="
              position:absolute;
              right:14px;
              bottom:8px;
              font-size:11px;
              color:#9ca3af;
              pointer-events:none;">
        ìˆ«ìë§Œ ì…ë ¥
      </span>
    </div>

    <!-- ğŸ”µ ì¶”ê°€: ê³„ì¢Œ ì•ˆë‚´ ë©”ì‹œì§€ (ì˜¤ë¥˜ ìˆ˜ì •) -->
    <div id="accountNumberMsg"
         style="display:none; color:#ef4444; font-size:12px; margin-top:6px;">
      ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.
    </div>

    <!-- ì œì¶œ ë²„íŠ¼ -->
    <button class="finish-btn" onclick="submitAll()">ì „ë¬¸ê°€ ë“±ë¡ ì™„ë£Œí•˜ê¸°</button>

</section>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
/* ========================================================== */
/*      Step4 ì…ë ¥ element mapping                             */
/* ========================================================== */
const STORY_FIELDS = {
  work: document.getElementById("story_work"),
  care: document.getElementById("story_care"),
  brand: document.getElementById("story_brand"),
  goal: document.getElementById("story_goal"),
};

/* ---------------- ì €ì¥ ---------------- */
function saveStep4() {
  const data = {
    work: STORY_FIELDS.work?.value || "",
    care: STORY_FIELDS.care?.value || "",
    brand: STORY_FIELDS.brand?.value || "",
    goal: STORY_FIELDS.goal?.value || "",
  };
  localStorage.setItem("expert_step4", JSON.stringify(data));
}

/* ---------------- ë¶ˆëŸ¬ì˜¤ê¸° ---------------- */
function loadStep4() {
  const saved = localStorage.getItem("expert_step4");
  if (!saved) return;

  const data = JSON.parse(saved);

  STORY_FIELDS.work.value  = data.work  || "";
  STORY_FIELDS.care.value  = data.care  || "";
  STORY_FIELDS.brand.value = data.brand || "";
  STORY_FIELDS.goal.value  = data.goal  || "";
}

/* ---------------- ì¹´ë“œ ì—´ê¸°/ë‹«ê¸° ---------------- */
function toggleCard(card) {
  card.classList.toggle("open");
}

/* ---------------- ìŠ¤í… ì´ë™ ---------------- */
function goStep(step) {
  const map = {
    intro: "expert-register-step1.html",
    career: "expert-register-step2.html",
    skill: "expert-register-step3.html",
    brand: "expert-register-step4.html",
  };
  location.href = map[step];
}

/* ==========================================================
   í•„ìˆ˜ í•­ëª© ì²´í¬ (Step1~Step4)
========================================================== */
function validateRequired(step1, step3, step4) {
  const missing = [];

  // Step1
  if (!step1.nickname) missing.push("ë‹‰ë„¤ì„");
  if (!step1.intro) missing.push("ì „ë¬¸ê°€ ì†Œê°œ");
  if (!step1.avatarPreview) missing.push("í”„ë¡œí•„ ì‚¬ì§„");
  if (!step1.topCategory) missing.push("ë©”ì¸ ì¹´í…Œê³ ë¦¬");
  if (!step1.subCategory) missing.push("ì„œë¸Œ ì¹´í…Œê³ ë¦¬");

  // Step3
  if (!step3.selectedSkills?.length) missing.push("ì „ë¬¸ ì—­ëŸ‰ ìŠ¤í‚¬");
  if (!step3.toolSkills?.length) missing.push("íˆ´ ìˆ™ë ¨ë„");
  if (!step3.strength) missing.push("ê°•ì ");

  // Step4
  if (!step4.work) missing.push("ì‘ì—… ì² í•™");
  if (!step4.care) missing.push("ê³ ê° ì¼€ì–´");
  if (!step4.brand) missing.push("ë¸Œëœë“œ ë°©í–¥");
  if (!step4.goal) missing.push("ì „ë¬¸ê°€ ëª©í‘œ");

  return missing;
}

/* ==========================================================
   ì „ë¬¸ê°€ ë“±ë¡ ìµœì¢… ì œì¶œ
========================================================== */
async function submitAll() {

  let step1 = JSON.parse(localStorage.getItem("expert_step1") || "{}");
  const step2 = JSON.parse(localStorage.getItem("expert_step2") || "{}");
  const step3 = JSON.parse(localStorage.getItem("expert_step3") || "{}");
  const savedStep4 = JSON.parse(localStorage.getItem("expert_step4") || "{}");

  // step1 ë³´ì •
  step1 = fixStep1(step1);

  // step4 ë³´ê°• (projects ì¤„ë°”ê¿ˆ â†’ array)
  const step4 = {
    ...savedStep4,
    solutions: document.getElementById("solutions")?.value || "",
    skills: document.getElementById("skills_text")?.value || "",
    projects:
      (document.getElementById("projects")?.value || "")
        .split("\n")
        .filter(v => v.trim().length > 0),
    brandStory: document.getElementById("brand_story")?.value || "",
  };

  // í•„ìˆ˜ í•­ëª© ê²€ì‚¬
  const missing = validateRequired(step1, step3, step4);
  if (missing.length > 0) {
    showToast("ëˆ„ë½ëœ í•­ëª©: " + missing.join(", "));
    return;
  }

  // STEP5 ê³„ì¢Œ
  const bankName = localStorage.getItem("expert_bankName") || "";
  const accountHolder = localStorage.getItem("expert_accountHolder") || "";
  const accountNumber = localStorage.getItem("expert_accountNumber") || "";

  const res = await fetch("https://blueon.up.railway.app/expert/submit", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({
      step1,
      step2,
      step3,
      step4,
      bankName,
      accountHolder,
      accountNumber
    })
  });

  const data = await res.json();

  if (data.success) {
    showToast("ì „ë¬¸ê°€ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
    setTimeout(() => location.href = "mypage.html", 1200);
  } else {
    showToast(data.message || "ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
  }
}

/* ==========================================================
   Step1 avatar/subCategory ë³´ì •
========================================================== */
function fixStep1(step1) {

  if (!step1.avatarPreview) {
    const avatars = [
      step1.avatar,
      step1.profile_image,
      step1.profileImage,
      step1.avatarUrl,
      localStorage.getItem("expert_avatar")
    ];
    step1.avatarPreview = avatars.find(v => v && v.length > 3) || "";
  }

  if (!step1.subCategory) {
    step1.subCategory =
      step1.selectedSub ||
      step1.sub ||
      step1.sub_category ||
      null;
  }

  return step1;
}

/* ==========================================================
   Step4 + Step5 ìë™ ì €ì¥
========================================================== */
function enableAutoSaveStep4() {
  Object.values(STORY_FIELDS).forEach(field => {
    field?.addEventListener("input", saveStep4);
  });

  document.getElementById("solutions")?.addEventListener("input", saveStep4);
  document.getElementById("skills_text")?.addEventListener("input", saveStep4);
  document.getElementById("projects")?.addEventListener("input", saveStep4);
  document.getElementById("brand_story")?.addEventListener("input", saveStep4);
}

function loadAccount() {
  document.getElementById("bankName").value =
    localStorage.getItem("expert_bankName") || "";

  document.getElementById("accountHolder").value =
    localStorage.getItem("expert_accountHolder") || "";

  document.getElementById("accountNumber").value =
    localStorage.getItem("expert_accountNumber") || "";
}

function saveAccount() {
  localStorage.setItem("expert_bankName",
    document.getElementById("bankName").value);

  localStorage.setItem("expert_accountHolder",
    document.getElementById("accountHolder").value);

  localStorage.setItem("expert_accountNumber",
    document.getElementById("accountNumber").value);
}

function enableAutoSaveAccount() {
  document.getElementById("bankName")?.addEventListener("input", saveAccount);
  document.getElementById("accountHolder")?.addEventListener("input", saveAccount);
  document.getElementById("accountNumber")?.addEventListener("input", saveAccount);
}

/* ==========================================================
   ê³„ì¢Œë²ˆí˜¸ ìˆ«ìë§Œ
========================================================== */
const accountNumberInput = document.getElementById("accountNumber");
const accountNumberMsg = document.getElementById("accountNumberMsg");

if (accountNumberInput) {
  accountNumberInput.addEventListener("input", (e) => {
    let value = e.target.value;
    const filtered = value.replace(/[^0-9]/g, "");

    if (value !== filtered) {
      accountNumberMsg.style.display = "block";
      accountNumberInput.classList.add("input-error");
      accountNumberInput.classList.remove("input-ok");
    } else {
      accountNumberMsg.style.display = "none";
      accountNumberInput.classList.remove("input-error");
      accountNumberInput.classList.add("input-ok");
    }

    e.target.value = filtered;
    saveAccount();
  });
}

/* ==========================================================
   ì´ˆê¸° ë¡œë“œ
========================================================== */
window.addEventListener("DOMContentLoaded", () => {
  loadStep4();
  enableAutoSaveStep4();

  loadAccount();
  enableAutoSaveAccount();
});

/* ==========================================================
   Toast
========================================================== */
function showToast(message) {
  let toast = document.getElementById("toast");
  if (!toast) return;
  toast.textContent = message;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2400);
}
</script>

</body>
</html>
