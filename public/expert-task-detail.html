<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BlueOn | ì „ë¬¸ê°€ ì‘ì—… ê´€ë¦¬</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --primary:#0056ff;
  --bg:#f4f6fb;
  --white:#ffffff;
  --line:#e5e7eb;
  --text:#111827;
  --gray:#6b7280;
}

* { box-sizing:border-box; margin:0; padding:0; }

body {
  font-family:"Noto Sans KR", sans-serif;
  background:var(--bg);
}

/* ===============================
   ìƒë‹¨ êµ¬ë§¤ ê´€ë¦¬ ìš”ì•½
================================ */
.top-summary {
  background:#fff;
  border-bottom:1px solid var(--line);
  padding:24px 20px;
}

.summary-grid {
  max-width:1100px;
  margin:0 auto;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:16px;
}

.summary-box {
  border:1px solid var(--line);
  border-radius:16px;
  padding:18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.summary-title {
  font-size:14px;
  color:var(--gray);
  font-weight:700;
}

.summary-count {
  font-size:22px;
  font-weight:800;
}

/* ===============================
   ë©”ì¸ ì»¨í…Œì´ë„ˆ
================================ */
.container {
  max-width:900px;
  margin:32px auto;
  padding:0 20px;
}

/* ===============================
   ì‘ì—… ì¹´ë“œ
================================ */
.task-card {
  background:#fff;
  border:1px solid var(--line);
  border-radius:18px;
  padding:26px;
}

.task-header {
  display:flex;
  gap:18px;
}

.task-thumb {
  width:90px;
  height:90px;
  border-radius:14px;
  object-fit:cover;
  border:1px solid var(--line);
  background:#eef2ff;
}

.task-info {
  flex:1;
}

.task-title {
  font-size:20px;
  font-weight:800;
  margin-bottom:6px;
}

.task-meta {
  font-size:14px;
  color:var(--gray);
  margin-bottom:6px;
}

.badge-row {
  display:flex;
  gap:8px;
  align-items:center;
}

.task-status {
  padding:6px 12px;
  border-radius:999px;
  font-size:13px;
  font-weight:800;
}

.status-pending { background:#fff7ed; color:#c2410c; }
.status-progress { background:#eff6ff; color:#1d4ed8; }
.status-done { background:#ecfdf5; color:#047857; }

/* ğŸ”¥ ìˆ˜ì • ìš”ì²­ ë°°ì§€ */
.revision-badge {
  padding:6px 10px;
  border-radius:999px;
  background:#fee2e2;
  color:#b91c1c;
  font-size:12px;
  font-weight:800;
  display:none;
}

/* ===============================
   ì•ˆë‚´ ì˜ì—­
================================ */
.task-guide {
  margin-top:22px;
  padding:18px;
  border-radius:14px;
  background:#f9fafb;
  border:1px dashed var(--line);
  font-size:14px;
  line-height:1.6;
}

/* ===============================
   ì•¡ì…˜
================================ */
.task-action {
  margin-top:20px;
  text-align:right;
}

.action-btn {
  padding:12px 22px;
  border-radius:12px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:800;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- ğŸ”¹ ìƒë‹¨ êµ¬ë§¤ ê´€ë¦¬ -->
<div class="top-summary">
  <div class="summary-grid">
    <div class="summary-box">
      <div class="summary-title">ì§„í–‰ì¤‘</div>
      <div class="summary-count">1</div>
    </div>
    <div class="summary-box">
      <div class="summary-title">ì‘ì—…ë¬¼ ë„ì°©</div>
      <div class="summary-count">0</div>
    </div>
    <div class="summary-box">
      <div class="summary-title">ì·¨ì†Œ Â· ë¬¸ì œ í•´ê²°</div>
      <div class="summary-count">0</div>
    </div>
    <div class="summary-box">
      <div class="summary-title">êµ¬ë§¤ í™•ì •</div>
      <div class="summary-count">0</div>
    </div>
  </div>
</div>

<div class="container">
  <div class="task-card">

    <div class="task-header">
      <img id="serviceThumb" class="task-thumb" src="/assets/default_service.png" />
      <div class="task-info">
        <div id="serviceTitle" class="task-title">ì„œë¹„ìŠ¤ ì œëª©</div>
        <div class="task-meta">
          ì˜ë¢°ì¸ Â· <span id="buyerName">ì˜ë¢°ì¸</span>
        </div>

        <div class="badge-row">
          <span id="taskStatusBadge" class="task-status status-pending">ì‘ì—… ì‹œì‘ ì „</span>
          <span id="revisionBadge" class="revision-badge">ìˆ˜ì • ìš”ì²­ 0íšŒ</span>
        </div>
      </div>
    </div>

    <div id="taskGuide" class="task-guide"></div>
    <div id="taskAction" class="task-action"></div>

  </div>
</div>

<script>
const API = "https://blueon.up.railway.app";
const taskKey = new URLSearchParams(location.search).get("task");

if (!taskKey) {
  alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
  location.href = "/expert-tasks.html";
}

/* ===============================
   ì‘ì—… ìƒì„¸
================================ */
async function loadTaskDetail() {
  const res = await fetch(
    `${API}/expert/tasks/detail?taskKey=${encodeURIComponent(taskKey)}`,
    { credentials:"include" }
  );
  const data = await res.json();

  if (!data.success) {
    alert("ì‘ì—… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  renderTask(data.task);
  loadRevisionCount();
  markRevisionAsRead(); // ğŸ”¥ step 3: ì½ìŒ ì²˜ë¦¬
}

/* ===============================
   ìˆ˜ì • ìš”ì²­ ê°œìˆ˜ ì¡°íšŒ
================================ */
async function loadRevisionCount() {
  const res = await fetch(
    `${API}/expert/tasks/revision-count?taskKey=${encodeURIComponent(taskKey)}`,
    { credentials:"include" }
  );
  const data = await res.json();

  if (!data.success) return;

  if (data.count > 0) {
    revisionBadge.style.display = "inline-block";
    revisionBadge.innerText = `ìˆ˜ì • ìš”ì²­ ${data.count}íšŒ`;
  } else {
    revisionBadge.style.display = "none";
  }
}

/* ===============================
   ğŸ”¥ ìˆ˜ì • ìš”ì²­ ì½ìŒ ì²˜ë¦¬
================================ */
async function markRevisionAsRead() {
  try {
    await fetch(`${API}/expert/tasks/revision-read`, {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ taskKey })
    });
  } catch (e) {
    console.error("revision read error:", e);
  }
}

/* ===============================
   ë Œë”ë§
================================ */
function renderTask(t) {
  serviceTitle.innerText = t.service_title;
  buyerName.innerText = t.buyer.nickname || "ì˜ë¢°ì¸";
  serviceThumb.src = t.thumbnail || "/assets/default_service.png";

  const badge = taskStatusBadge;
  badge.className = "task-status";

  // ğŸ”¥ í•µì‹¬: service_tasks.status ê¸°ì¤€
  switch (t.status) {
    case "start":
      badge.classList.add("status-pending");
      badge.innerText = "ì‘ì—… ì‹œì‘ ì „";
      taskGuide.innerHTML = "ì‘ì—… ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”.";
      taskAction.innerHTML =
        `<button class="action-btn" onclick="startTask()">ì‘ì—… ì‹œì‘í•˜ê¸°</button>`;
      break;

    case "progress":
      badge.classList.add("status-progress");
      badge.innerText = "ì§„í–‰ì¤‘";
      taskGuide.innerHTML = "ì˜ë¢°ì¸ì˜ ìˆ˜ì • ìš”ì²­ì´ ìˆìœ¼ë©´ ìƒë‹¨ì— í‘œì‹œë©ë‹ˆë‹¤.";
      taskAction.innerHTML =
        `<button class="action-btn" onclick="goChat(${t.room_id})">ì±„íŒ…ìœ¼ë¡œ ì´ë™</button>`;
      break;

    case "done":
      badge.classList.add("status-done");
      badge.innerText = "ì‘ì—… ì™„ë£Œ";
      taskGuide.innerHTML = "ì˜ë¢°ì¸ì´ ê²°ê³¼ë¬¼ì„ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤.";
      taskAction.innerHTML = "";
      break;

    default:
      badge.innerText = "ì•Œ ìˆ˜ ì—†ìŒ";
      taskGuide.innerHTML = "";
      taskAction.innerHTML = "";
  }
}

/* ===============================
   ì‘ì—… ì‹œì‘
================================ */
async function startTask() {
  await fetch(`${API}/expert/tasks/start`, {
    method:"POST",
    credentials:"include",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ taskKey })
  });
  loadTaskDetail();
}

function goChat(roomId) {
  location.href = `/chat.html?room=${roomId}`;
}

loadTaskDetail();
</script>

</body>
</html>
