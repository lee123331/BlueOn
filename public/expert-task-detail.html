<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BlueOn | ì‘ì—… ìƒì„¸</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --primary:#0056ff;
  --bg:#f4f6fb;
  --white:#ffffff;
  --line:#e5e7eb;
  --text-dark:#111827;
  --text-gray:#6b7280;
}

* { box-sizing:border-box; margin:0; padding:0; }

body {
  font-family:"Noto Sans KR", sans-serif;
  background:var(--bg);
}

/* ===============================
   ìƒë‹¨ ë‹¨ê³„ í‘œì‹œ ë°”
================================ */
.step-bar {
  background:var(--white);
  padding:20px;
  border-bottom:1px solid var(--line);
}

.step-buttons {
  max-width:1000px;
  margin:0 auto;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:12px;
}

.step-btn {
  padding:14px;
  border-radius:12px;
  border:1px solid var(--line);
  text-align:center;
  font-weight:700;
  font-size:14px;
  background:#f9fafb;
  color:var(--text-gray);
}

.step-btn.active {
  background:var(--primary);
  color:#fff;
  border-color:var(--primary);
}

.step-btn span {
  display:block;
  font-size:12px;
  margin-top:4px;
  font-weight:500;
  opacity:0.9;
}

/* ===============================
   ë©”ì¸ ì»¨í…Œì´ë„ˆ
================================ */
.container {
  max-width:900px;
  margin:30px auto;
  padding:0 20px;
}

/* ===============================
   ì‘ì—… ìš”ì•½ ì¹´ë“œ
================================ */
.task-card {
  background:var(--white);
  border:1px solid var(--line);
  border-radius:16px;
  padding:24px;
}

.task-header {
  display:flex;
  gap:16px;
  align-items:center;
}

.task-thumb {
  width:80px;
  height:80px;
  border-radius:12px;
  object-fit:cover;
  border:1px solid var(--line);
  background:#eef2ff;
}

.task-info {
  display:flex;
  flex-direction:column;
  gap:6px;
}

.task-title {
  font-size:20px;
  font-weight:800;
  color:var(--text-dark);
}

.task-meta {
  font-size:14px;
  color:var(--text-gray);
}

/* ===============================
   ë‹¨ê³„ ì•ˆë‚´ ì¹´ë“œ
================================ */
.task-step {
  margin-top:20px;
  padding:20px;
  border-radius:14px;
  background:#f9fafb;
  border:1px dashed var(--line);
  font-size:14px;
  line-height:1.6;
  color:var(--text-dark);
}

/* ===============================
   ì•¡ì…˜ ì˜ì—­
================================ */
.task-action {
  margin-top:20px;
}

.action-btn {
  padding:12px 22px;
  border-radius:12px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:800;
  font-size:14px;
  cursor:pointer;
}

.action-btn:hover {
  opacity:0.9;
}
</style>
</head>

<body>

<!-- ğŸ”¹ ë‹¨ê³„ í‘œì‹œ -->
<div class="step-bar">
  <div class="step-buttons">
    <div class="step-btn active">
      ì‘ì—… ì‹œì‘í•˜ê¸°
      <span>ê²°ì œ ì™„ë£Œ Â· ì‘ì—… ì¤€ë¹„</span>
    </div>
    <div class="step-btn">
      ì‹œì•ˆ ì œì¶œí•˜ê¸°
      <span>1ì°¨ ê²°ê³¼ë¬¼</span>
    </div>
    <div class="step-btn">
      ì‘ì—… ìˆ˜ì •í•˜ê¸°
      <span>ìˆ˜ì • ìš”ì²­ ëŒ€ì‘</span>
    </div>
    <div class="step-btn">
      ìµœì¢… ì œì¶œ
      <span>ì‘ì—… ì™„ë£Œ</span>
    </div>
  </div>
</div>

<div class="container">

  <!-- ğŸ”µ ì‘ì—… ìš”ì•½ -->
  <div class="task-card">

    <div class="task-header">
      <img id="serviceThumb" class="task-thumb" src="/assets/default_service.png" />
      <div class="task-info">
        <div id="serviceTitle" class="task-title">ì„œë¹„ìŠ¤ ì œëª©</div>
        <div class="task-meta">
          <span id="buyerName">ì˜ë¢°ì¸ ê³ ê°</span>
        </div>
        <div class="task-meta">
          ìƒíƒœ: <span id="taskStatus">pending</span>
        </div>
      </div>
    </div>

    <!-- ğŸ”½ ë‹¨ê³„ ì•ˆë‚´ -->
    <div id="taskStepInfo" class="task-step"></div>

    <!-- ğŸ”½ ì•¡ì…˜ -->
    <div id="taskAction" class="task-action"></div>

  </div>

</div>

<script>
const API_URL = "https://blueon.up.railway.app";
const params = new URLSearchParams(location.search);
const taskKey = params.get("task");

if (!taskKey) {
  alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
  location.href = "/expert-tasks.html";
}

/* ===============================
   ì‘ì—… ìƒì„¸ ë¡œë“œ
================================ */
async function loadTaskDetail() {
  const res = await fetch(
    `${API_URL}/expert/tasks/detail?taskKey=${encodeURIComponent(taskKey)}`,
    { credentials: "include" }
  );
  const data = await res.json();

  if (!data.success) {
    alert("ì‘ì—… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  renderTask(data.task);
}

/* ===============================
   ë Œë”ë§
================================ */
function renderTask(t) {
  document.getElementById("serviceTitle").innerText = t.service_title;
  document.getElementById("buyerName").innerText =
    t.buyer.nickname || "ì˜ë¢°ì¸ ê³ ê°";
  document.getElementById("taskStatus").innerText = t.status;

  document.getElementById("serviceThumb").src =
    t.thumbnail || "/assets/default_service.png";

  const action = document.getElementById("taskAction");
  const stepInfo = document.getElementById("taskStepInfo");

  action.innerHTML = "";
  stepInfo.innerHTML = "";

  if (t.status === "pending") {
    stepInfo.innerHTML = `
      <b>ì‘ì—… ì‹œì‘ ì „ ë‹¨ê³„</b><br/>
      ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br/>
      ì‘ì—…ì„ ì‹œì‘í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
    `;
    action.innerHTML = `
      <button class="action-btn" onclick="startTask()">
        ì‘ì—… ì‹œì‘í•˜ê¸°
      </button>
    `;
  }
  else if (t.status === "progress") {
    stepInfo.innerHTML = `
      <b>ì‘ì—… ì§„í–‰ ì¤‘</b><br/>
      ì‹œì•ˆì„ ì œì‘í•˜ì—¬ 1ì°¨ ê²°ê³¼ë¬¼ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.<br/>
      ì˜ë¢°ì¸ê³¼ì˜ ì†Œí†µì€ ì±„íŒ…ì„ ì´ìš©í•˜ì„¸ìš”.
    `;
    action.innerHTML = `
      <button class="action-btn" onclick="goChat(${t.room_id})">
        ì±„íŒ…ìœ¼ë¡œ ì´ë™
      </button>
    `;
  }
  else if (t.status === "done") {
    stepInfo.innerHTML = `
      <b>ì‘ì—… ì™„ë£Œ</b><br/>
      ì˜ë¢°ì¸ì´ ê²°ê³¼ë¬¼ì„ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤.
    `;
  }
}

/* ===============================
   ì‘ì—… ì‹œì‘
================================ */
async function startTask() {
  const res = await fetch(`${API_URL}/expert/tasks/start`, {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ taskKey })
  });

  const data = await res.json();
  if (!data.success) {
    alert("ì‘ì—… ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    return;
  }

  loadTaskDetail();
}

/* ===============================
   ì±„íŒ… ì´ë™
================================ */
function goChat(roomId) {
  location.href = `/chat.html?room=${roomId}`;
}

loadTaskDetail();
</script>

</body>
</html>
