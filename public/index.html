<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BlueOn | ì „ë¬¸ê°€ ë§¤ì¹­ í”Œë«í¼</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary:#0056ff;
      --bg:#f9fafb;
      --white:#ffffff;
      --line:#e5e7eb;
      --text-dark:#111827;
      --text-gray:#6b7280;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:"Noto Sans KR",sans-serif;
      background:var(--bg);
      color:var(--text-dark);
    }

    header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:18px 70px;
      background:#fff;
      border-bottom:1px solid var(--line);
    }

    .logo {
      font-size:22px;
      font-weight:800;
      color:var(--primary);
      cursor:pointer;
    }

    .header-notice { position:relative; cursor:pointer; }
    .notice-bell { font-size:22px; }
    .notice-badge {
      position:absolute;
      top:-6px;
      right:-8px;
      background:#ff3b30;
      color:#fff;
      font-size:11px;
      border-radius:50%;
      padding:2px 6px;
      display:none;
    }

    .notice-panel {
      position:absolute;
      right:-40px;
      top:36px;
      width:360px;
      background:#fff;
      border-radius:16px;
      box-shadow:0 6px 24px rgba(0,0,0,.12);
      display:none;
      z-index:1000;
      padding:16px;
    }

    .notice-item {
      padding:14px;
      border-radius:12px;
      border:1px solid var(--line);
      margin-bottom:10px;
      cursor:pointer;
    }

    .notice-item:hover {
      background:#f5f8ff;
    }
  </style>
</head>

<body>

<header>
  <div class="logo" onclick="location.href='index.html'">BlueOn</div>

  <div style="display:flex;align-items:center;gap:18px;">
    <div class="header-notice" id="noticeIcon">
      <span class="notice-bell">ğŸ””</span>
      <span class="notice-badge" id="noticeBadge">0</span>

      <div class="notice-panel" id="noticePanel">
        <div id="noticeContent">
          <p style="text-align:center;color:#6b7280;">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
      </div>
    </div>

    <div style="cursor:pointer;" onclick="location.href='chat.html'">ğŸ’¬</div>
  </div>
</header>

<script>
const API_URL = "https://blueon.up.railway.app";

const noticeIcon   = document.getElementById("noticeIcon");
const noticePanel  = document.getElementById("noticePanel");
const noticeBadge  = document.getElementById("noticeBadge");
const noticeContent= document.getElementById("noticeContent");

/* ğŸ”” ì•Œë¦¼ íŒ¨ë„ í† ê¸€ */
noticeIcon.onclick = async (e) => {
  e.stopPropagation();
  const open = noticePanel.style.display === "block";
  noticePanel.style.display = open ? "none" : "block";

  if (!open) loadNotices();
};

document.addEventListener("click", () => {
  noticePanel.style.display = "none";
});

/* ğŸ”” ì•Œë¦¼ ë¡œë“œ */
async function loadNotices() {
  noticeContent.innerHTML = "";

  try {
    const res = await fetch(`${API_URL}/notice/list`, {
      credentials:"include"
    });
    const data = await res.json();

    if (!data.success || !data.notices.length) {
      noticeContent.innerHTML =
        `<p style="text-align:center;color:#6b7280;">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p>`;
      noticeBadge.style.display = "none";
      return;
    }

    noticeBadge.textContent = data.notices.length;
    noticeBadge.style.display = "block";

    data.notices.forEach(n => {
      const div = document.createElement("div");
      div.className = "notice-item";
      div.innerHTML = `
        <div style="font-size:14px;font-weight:600;">${n.message}</div>
        <div style="font-size:12px;color:#6b7280;margin-top:4px;">
          ${new Date(n.created_at).toLocaleString("ko-KR")}
        </div>
      `;

      div.onclick = async () => {
        await fetch(`${API_URL}/notice/read/${n.id}`, {
          method:"POST",
          credentials:"include"
        });
        noticePanel.style.display = "none";

        if (n.room_id) {
          location.href = `chat.html?room=${n.room_id}`;
        }
      };

      noticeContent.appendChild(div);
    });

  } catch (e) {
    noticeContent.innerHTML =
      `<p style="text-align:center;color:#ef4444;">ì•Œë¦¼ ë¡œë“œ ì‹¤íŒ¨</p>`;
  }
}

/* ğŸ”´ ì•ˆ ì½ì€ ì•Œë¦¼ ë±ƒì§€ */
(async function(){
  try {
    const res = await fetch(`${API_URL}/notice/unread-count`, {
      credentials:"include"
    });
    const data = await res.json();
    if (data.success && data.count > 0) {
      noticeBadge.textContent = data.count;
      noticeBadge.style.display = "block";
    }
  } catch {}
})();
</script>

<script src="/socket.io/socket.io.js"></script>
<script src="/header-chat.js"></script>

</body>
</html>
