<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ë§ˆì´í˜ì´ì§€ | BlueOn</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">

<style>
body {
  font-family: "Noto Sans KR", sans-serif;
  margin: 0;
  background: linear-gradient(180deg, #eef2ff 0, #f5f6fa 120px);
}

/* HEADER */
header {
  position: sticky;
  top: 0;
  z-index: 50;
  background: rgba(255,255,255,0.96);
  backdrop-filter: blur(8px);
  padding: 16px 60px;
  border-bottom: 1px solid #e5e7eb;
  font-weight: 800;
  font-size: 22px;
  color: #0056ff;
  cursor: pointer;
}

/* MAIN WRAPPER */
.main-wrapper {
  max-width: 1180px;
  margin: 32px auto 60px;
  padding: 0 24px 40px;
}

/* =========================
   ìƒë‹¨ ì „ë¬¸ê°€ í”„ë¡œí•„ ì„¹ì…˜
========================= */
.profile-section {
  margin-bottom: 40px;
}

.expert-profile-wrapper {
  display: flex;
  justify-content: center;
}

.expert-profile-box {
  width: 100%;
  max-width: 980px;
  display: flex;
  gap: 26px;
  background: #ffffff;
  padding: 30px 34px;
  border-radius: 20px;
  box-shadow: 0 10px 28px rgba(15,23,42,0.08);
  border: 1px solid #e5e7eb;
}

/* í”„ë¡œí•„ ì´ë¯¸ì§€ */
.expert-avatar {
  width: 104px;
  height: 104px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid #e5e7eb;
}

/* ì „ë¬¸ê°€ ì •ë³´ */
.expert-info {
  flex: 1;
  min-width: 0;
}

.expert-top-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}

.expert-name {
  font-size: 22px;
  font-weight: 800;
}

.edit-profile-btn {
  background: #0056ff;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(37,99,235,0.25);
}
.edit-profile-btn:hover {
  background: #003fcc;
}

/* ì†Œê°œê¸€ */
.expert-intro-wrapper {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 8px;
  max-width: 580px;
}

.expert-intro-label {
  font-size: 12px;
  font-weight: 700;
  color: #2563eb;
  padding: 2px 8px;
  border-radius: 999px;
  background: #e0ecff;
}

.expert-intro {
  font-size: 14px;
  color: #4b5563;
  line-height: 1.6;
  transition: 0.25s ease;
  flex: 1;
}

/* ì ‘íŒ ìƒíƒœ */
.expert-intro.collapsed {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* í¼ì¹¨/ì ‘ê¸° ë²„íŠ¼ */
.toggle-intro-btn {
  font-size: 16px;
  cursor: pointer;
  user-select: none;
  color: #6b7280;
}
.toggle-intro-btn:hover {
  color: #111827;
}

/* í†µê³„ */
.expert-stats {
  display: flex;
  gap: 24px;
  margin-top: 12px;
  font-size: 13px;
  color: #6b7280;
}

.expert-stat-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.expert-stat-icon {
  font-size: 14px;
}

.expert-stats strong {
  font-size: 15px;
  color: #111827;
  font-weight: 800;
}

/* =========================
   ì„œë¹„ìŠ¤ ì„¹ì…˜ íƒ€ì´í‹€
========================= */
.section-head {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  margin: 40px 0 10px;
}

.section-title {
  font-size: 24px;
  font-weight: 800;
  letter-spacing: -0.02em;
}

.section-subtitle {
  font-size: 13px;
  color: #6b7280;
  margin-top: 4px;
}

.section-meta {
  font-size: 13px;
  color: #9ca3af;
}

/* ì–‡ì€ êµ¬ë¶„ì„  */
.section-divider {
  height: 1px;
  width: 100%;
  margin-bottom: 22px;
  background: linear-gradient(90deg, rgba(59,130,246,0.4), rgba(148,163,184,0.1));
}

/* =========================
   ì„œë¹„ìŠ¤ ì¹´ë“œ ê·¸ë¦¬ë“œ
========================= */
.service-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(310px, 1fr));
  gap: 26px;
}

/* CARD */
.service-card {
  background: #ffffff;
  border-radius: 18px;
  overflow: hidden;
  border: 1px solid #e5e7eb;
  box-shadow: 0 6px 18px rgba(15,23,42,0.08);
  transition: 0.22s;
  position: relative;
  cursor: pointer;
}
.service-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 26px rgba(15,23,42,0.15);
}

/* ì¹´ë“œ ìƒë‹¨ ì‘ì€ íƒœê·¸ */
.card-badge {
  position: absolute;
  top: 14px;
  left: 14px;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  color: #1d4ed8;
  background: rgba(219,234,254,0.95);
}

/* â‹® ë©”ë‰´ ë²„íŠ¼ */
.card-menu-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  background: #ffffffcc;
  backdrop-filter: blur(8px);
  width: 32px;
  height: 32px;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 10px;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  opacity: 0;
  transition: 0.2s;
  z-index: 10;
}
.service-card:hover .card-menu-btn {
  opacity: 1;
}

/* ë“œë¡­ë‹¤ìš´ ë©”ë‰´ */
.card-dropdown {
  position: absolute;
  top: 50px;
  right: 12px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 8px 0;
  width: 140px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
  display: none;
  z-index: 20;
}
.card-dropdown.show {
  display: block;
}
.card-dropdown button {
  width: 100%;
  background: none;
  border: none;
  padding: 10px 14px;
  font-size: 14px;
  text-align: left;
  cursor: pointer;
  color: #ef4444;
}
.card-dropdown button:hover {
  background: #fef2f2;
}

/* ì¸ë„¤ì¼ */
.thumb-box {
  aspect-ratio: 4 / 3;
  background: #f3f4f6;
  overflow: hidden;
}
.thumb-box img.thumb {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* ì¹´ë“œ ë³¸ë¬¸ */
.card-body {
  padding: 18px 18px 16px;
}
.card-title {
  font-size: 17px;
  font-weight: 700;
  margin-bottom: 6px;
  line-height: 1.35;
}
.card-price {
  font-size: 16px;
  font-weight: 800;
  color: #0056ff;
  margin-top: 2px;
}
.card-category {
  font-size: 13px;
  margin-top: 4px;
  color: #6b7280;
}

/* Empty */
.empty-box {
  text-align: center;
  padding: 60px 20px;
  font-size: 18px;
  color: #777;
  background: #ffffff;
  border-radius: 16px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 4px 14px rgba(0,0,0,0.04);
}
.toggle-intro-btn {
  font-size: 12px;
  padding: 0 4px;       /* í´ë¦­ ë²”ìœ„ í™•ë³´ */
  cursor: pointer;
  user-select: none;
  color: #6b7280;
}
.toggle-intro-btn:hover {
  color: #111827;
}

/* ì‚­ì œ ëª¨ë‹¬ & í† ìŠ¤íŠ¸ëŠ” ê¸°ì¡´ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥ */
</style>
</head>

<body>

<header onclick="location.href='index.html'">BlueOn</header>

<main class="main-wrapper">

  <!-- ìƒë‹¨ ì „ë¬¸ê°€ í”„ë¡œí•„ -->
  <section class="profile-section">
    <div class="expert-profile-wrapper">
      <div class="expert-profile-box">
        <img src="/assets/default_profile.png" id="expertAvatar" class="expert-avatar">


        <div class="expert-info">
          <div class="expert-top-row">
            <h2 id="expertName" class="expert-name">ì „ë¬¸ê°€ ë‹‰ë„¤ì„</h2>
            <button class="edit-profile-btn" onclick="location.href='expert-register-step1.html'">
              í”„ë¡œí•„ ê´€ë¦¬
            </button>
          </div>

          <div class="expert-intro-wrapper">
            <span class="expert-intro-label">ì „ë¬¸ê°€ ì†Œê°œ</span>
            <p id="expertIntro" class="expert-intro collapsed">
              ì—¬ê¸°ì— ì „ë¬¸ê°€ ì†Œê°œê¸€ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤. ê¸€ì´ ê¸¸ì–´ì§€ë©´ í•œ ì¤„ë¡œ ì¤„ì–´ë“¤ê³  í¼ì¹˜ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì „ì²´ê°€ ë³´ì…ë‹ˆë‹¤.
            </p>
            <span id="toggleIntroBtn" class="toggle-intro-btn">ë”ë³´ê¸°</span>
          </div>

          <div class="expert-stats">
            <div class="expert-stat-item">
              <span class="expert-stat-icon">ğŸ› </span>
              <span><strong id="svcCount">0</strong> ì„œë¹„ìŠ¤</span>
            </div>
            <div class="expert-stat-item">
              <span class="expert-stat-icon">ğŸ’¸</span>
              <span><strong id="salesCount">0</strong> íŒë§¤</span>
            </div>
            <div class="expert-stat-item">
              <span class="expert-stat-icon">ğŸ’¬</span>
              <span><strong id="chatCount">0</strong> ë¬¸ì˜</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ì„œë¹„ìŠ¤ ì„¹ì…˜ -->
  <section>
    <div class="section-head">
      <div>
        <h2 class="section-title">ë‚´ ì„œë¹„ìŠ¤ ëª©ë¡</h2>
        <p class="section-subtitle">ë“±ë¡í•œ ì„œë¹„ìŠ¤ ì¹´ë“œë“¤ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬í•  ìˆ˜ ìˆì–´ìš”.</p>
      </div>
      <div class="section-meta">
        ì¹´ë“œ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™ Â· ì˜¤ë¥¸ìª½ ì  3ê°œ ë²„íŠ¼ìœ¼ë¡œ ì‚­ì œ ê°€ëŠ¥
      </div>
    </div>

    <div class="section-divider"></div>

    <div id="serviceList" class="service-grid"></div>
  </section>
<!-- ì‚­ì œ ëª¨ë‹¬ -->
<div id="deleteModal" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  place-items: center;
  z-index: 200;
">
  <div style="
    background: #fff;
    padding: 26px;
    border-radius: 14px;
    width: 90%;
    max-width: 380px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.2);
    text-align: center;
  ">
    <h3 style="font-size:18px; font-weight:800; margin-bottom:10px;">ì„œë¹„ìŠ¤ ì‚­ì œ</h3>
    <p style="font-size:14px; color:#555; margin-bottom:20px;">
      ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    </p>

    <button id="confirmDeleteBtn" style="
      width:100%;
      padding:12px;
      background:#ef4444;
      color:white;
      border:none;
      border-radius:8px;
      font-size:15px;
      margin-bottom:10px;
      cursor:pointer;
    ">ì‚­ì œí•˜ê¸°</button>

    <button id="cancelDeleteBtn" style="
      width:100%;
      padding:12px;
      background:#e5e7eb;
      color:#111;
      border:none;
      border-radius:8px;
      font-size:15px;
      cursor:pointer;
    ">ì·¨ì†Œ</button>
  </div>
</div>

</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const API = "http://localhost:3000";

  /* --------------------------
      JSON Safe Parse
  --------------------------- */
  function safeJsonParse(value) {
    if (!value) return [];
    if (Array.isArray(value)) return value;
    try { return JSON.parse(value.replace(/'/g, '"')); }
    catch { return []; }
  }

/* --------------------------
    Toast ì•ŒëŒ (ìš°ì¸¡ ìƒë‹¨)
--------------------------- */
function toast(message) {
  const t = document.getElementById("toast");
  t.textContent = message;

  // ë³´ì—¬ì£¼ê¸°
  t.style.opacity = "1";
  t.style.transform = "translateY(0)";

  // 2ì´ˆ ë’¤ ì‚¬ë¼ì§€ê¸°
  setTimeout(() => {
    t.style.opacity = "0";
    t.style.transform = "translateY(-20px)";
  }, 2000);
}

  /* --------------------------
      ì„œë¹„ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°
  --------------------------- */
  async function loadServices() {
    try {
      const res = await fetch(`${API}/expert/my-services`, { credentials:"include" });
      const data = await res.json();

      const list = document.getElementById("serviceList");
      list.innerHTML = "";

      if (!data.success || data.services.length === 0) {
        list.innerHTML = `<div class="empty-box">ë“±ë¡ëœ ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      data.services.forEach((svc) => {
        const imgs = safeJsonParse(svc.main_images);
        const thumbnail = imgs[0] || "/assets/default_service.jpg";

        const card = document.createElement("div");
        card.classList.add("service-card");
        card.dataset.id = svc.id;

        card.innerHTML = `
          <div class="card-menu-btn">â‹®</div>

          <div class="card-dropdown">
            <button class="delete-service-btn" data-id="${svc.id}">ì„œë¹„ìŠ¤ ì‚­ì œ</button>
          </div>

          <div class="thumb-box">
            <img class="thumb" src="${thumbnail}" />
          </div>

          <div class="card-body">
            <div class="card-title">${svc.title}</div>
            <div class="card-price">${Number(svc.price_basic).toLocaleString()}ì›~</div>
            <div class="card-category">${svc.sub_category}</div>
          </div>
        `;

        // ì¹´ë“œ í´ë¦­ â†’ ìƒì„¸ í˜ì´ì§€ ì´ë™
        card.addEventListener("click", (e) => {
          if (e.target.closest(".card-menu-btn") || e.target.closest(".card-dropdown")) return;
          location.href = `service-detail.html?id=${svc.id}`;
        });

        list.appendChild(card);
      });

    } catch (err) {
      console.error("ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
    }
  }

  /* --------------------------
      â‹® ë©”ë‰´ í† ê¸€
  --------------------------- */
  document.addEventListener("click", (e) => {
    const menuBtn = e.target.closest(".card-menu-btn");
    const dropdown = e.target.closest(".card-dropdown");

    document.querySelectorAll(".card-dropdown").forEach(d => d.classList.remove("show"));

    if (menuBtn) {
      menuBtn.nextElementSibling.classList.add("show");
      e.stopPropagation();
    }

    if (dropdown) e.stopPropagation();
  });

  /* --------------------------
      ì‚­ì œ ë²„íŠ¼ í´ë¦­ â†’ ëª¨ë‹¬ ì—´ê¸°
  --------------------------- */
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".delete-service-btn");
    if (!btn) return;

    deleteTargetId = btn.dataset.id;
    document.getElementById("deleteModal").style.display = "grid";
  });

  /* --------------------------
      ëª¨ë‹¬ ì·¨ì†Œ
  --------------------------- */
  document.getElementById("cancelDeleteBtn").onclick = () => {
    document.getElementById("deleteModal").style.display = "none";
    deleteTargetId = null;
  };

  /* --------------------------
      ëª¨ë‹¬ ì‚­ì œ ì‹¤í–‰
  --------------------------- */
  document.getElementById("confirmDeleteBtn").onclick = async () => {
    if (!deleteTargetId) return;

    const res = await fetch(`${API}/expert/delete-service/${deleteTargetId}`, {
      method: "DELETE",
      credentials: "include"
    });
    const data = await res.json();

    if (data.success) {
      document.querySelector(`.service-card[data-id="${deleteTargetId}"]`).remove();
      toast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    } else {
      toast("ì‚­ì œ ì‹¤íŒ¨: " + data.message);
    }

    document.getElementById("deleteModal").style.display = "none";
    deleteTargetId = null;
  };
const intro = document.getElementById("expertIntro");
const toggleBtn = document.getElementById("toggleIntroBtn");

toggleBtn.addEventListener("click", () => {
  const isCollapsed = intro.classList.contains("collapsed");

  if (isCollapsed) {
    intro.classList.remove("collapsed");
    toggleBtn.textContent = "ì ‘ê¸°"; // í¼ì³ì¡Œì„ ë•Œ ìœ„ í™”ì‚´í‘œ
  } else {
    intro.classList.add("collapsed");
    toggleBtn.textContent = "ë”ë³´ê¸°"; // ì ‘í˜”ì„ ë•Œ ì•„ë˜ í™”ì‚´í‘œ
  }
});
async function loadExpertProfile() {
  try {
    const res = await fetch(`${API}/expert/mypage`, { credentials: "include" });
    const data = await res.json();

    if (!data.success || !data.profile) return;

    const p = data.profile;

    /* ============================================
       ğŸ”µ í”„ë¡œí•„ ì´ë¯¸ì§€ ì²˜ë¦¬
    ============================================ */
    const avatarEl = document.getElementById("expertAvatar");
    let avatar = p.avatar_url;

    if (!avatar) {
      avatar = "/assets/default_profile.png";
    } else {
      // ì—…ë¡œë“œëœ ê²½ë¡œê°€ /uploads/... í˜•ì‹ì¸ì§€ ê²€ì‚¬
      if (!avatar.startsWith("/uploads/") && !avatar.startsWith("/assets/")) {
        avatar = "/uploads/" + avatar;
      }
    }

    avatarEl.src = avatar;


    /* ============================================
       ğŸ”µ ë‹‰ë„¤ì„ / ì†Œê°œê¸€
    ============================================ */
    document.getElementById("expertName").textContent =
      p.nickname || "ì „ë¬¸ê°€";

    document.getElementById("expertIntro").textContent =
      p.intro || "ì•„ì§ ì†Œê°œê¸€ì´ ì—†ìŠµë‹ˆë‹¤!";


    /* ============================================
       ğŸ”µ í†µê³„ ìˆ«ì í‘œì‹œ
       serviceCount â†’ ë“±ë¡ ì„œë¹„ìŠ¤ ìˆ˜
       salesCount â†’ íŒë§¤ ìˆ˜ (buy_count)
       chatCount â†’ ë¬¸ì˜ ìˆ˜ (ì±„íŒ…ë°© ê°œìˆ˜)
    ============================================ */
    document.getElementById("svcCount").textContent = p.serviceCount ?? 0;
    document.getElementById("salesCount").textContent = p.salesCount ?? 0;
    document.getElementById("chatCount").textContent = p.chatCount ?? 0;

  } catch (err) {
    console.error("loadExpertProfile error:", err);
  }
}


  /* --------------------------
      ìµœì´ˆ ì‹¤í–‰
  --------------------------- */
loadExpertProfile();
loadServices();


});
</script>
<!-- Toast -->
<div id="toast" style="
  position: fixed;
  top: 20px;
  right: 20px;
  background: #333;
  color: white;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 14px;
  opacity: 0;
  transform: translateY(-20px);
  transition: all 0.3s ease;
  z-index: 9999;
"></div>

</body>
</html>
