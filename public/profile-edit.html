<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BlueOn | í”„ë¡œí•„ ì„¤ì •</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">

<style>
:root {
  --primary: #0056ff;
  --bg: #f9fafb;
  --white: #ffffff;
  --text-dark: #111827;
  --text-gray: #6b7280;
  --line: #e5e7eb;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:"Noto Sans KR",sans-serif;
  background:var(--bg);
  color:var(--text-dark);
  font-size:16px;
}
/* HEADER */
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:18px 70px;
  background:var(--white);
  border-bottom:1px solid var(--line);
}
.logo{font-size:22px;font-weight:800;color:var(--primary);cursor:pointer;}
header img#headerAvatar{
  width:40px;height:40px;border-radius:50%;object-fit:cover;cursor:pointer;
}
/* ì „ì²´ ë ˆì´ì•„ì›ƒ */
.profile-layout{
  display:flex;
  max-width:1300px;
  margin:60px auto;
  gap:40px;
}
.sidebar{width:240px;padding:20px 10px;}
.sidebar h3{font-size:18px;font-weight:700;margin-bottom:15px;color:var(--primary);}
.content{
  flex:1;background:var(--white);border:1px solid var(--line);
  border-radius:12px;padding:40px 50px;box-shadow:0 6px 18px rgba(0,0,0,0.04);
}
.content h2{font-size:22px;font-weight:700;margin-bottom:30px;}
.profile-area{display:flex;align-items:flex-start;gap:50px;}
.profile-left{display:flex;flex-direction:column;align-items:center;width:160px;}
.profile-left img{
  width:110px;height:110px;border-radius:50%;object-fit:cover;background-color:#fff;
  border:none;box-shadow:0 2px 8px rgba(0,0,0,0.08);
}
.profile-left button{
  background:var(--primary);color:#fff;border:none;padding:8px 18px;border-radius:8px;
  cursor:pointer;font-size:14px;margin-top:10px;transition:0.2s;
}
.profile-left button:hover{background:#0044cc;}
.profile-right{flex:1;display:flex;flex-direction:column;gap:20px;}
.nickname-section label{font-weight:600;margin-bottom:6px;display:block;}
.nickname-input{
  display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);
  border-radius:6px;padding:10px 14px;background:#f9fafb;
}
.nickname-input input{border:none;background:transparent;font-size:16px;outline:none;width:100%;}
.nickname-input span{font-size:14px;color:var(--text-gray);}

/* ë‹‰ë„¤ì„ ìƒíƒœ ë©”ì‹œì§€ */
#nickname-status {
  font-size: 14px;
  margin-top: 4px;
  font-weight: 600;
}

.textarea-section textarea{width:100%;height:120px;border:1px solid var(--line);border-radius:6px;padding:12px;resize:none;font-size:15px;}
.textarea-section textarea:focus{border-color:var(--primary);}
.textarea-section small{display:block;text-align:right;font-size:13px;color:var(--text-gray);margin-top:4px;}
.tip-box{background:#eaf1ff;border:1px solid #bcd3ff;border-radius:8px;padding:14px 18px;font-size:14px;color:#1e3a8a;margin:10px 0;font-weight:500;}
.change-btn{align-self:flex-end;background:#111;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:15px;}
.change-btn:hover{background:#333;}
/* ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ */
.password-box{border-top:1px solid var(--line);margin-top:50px;padding-top:40px;}
.password-box h3{font-size:18px;font-weight:700;margin-bottom:20px;}
.alert-box{background:#f4f8ff;border:1px solid #d6e4ff;border-radius:8px;padding:14px 18px;font-size:14px;color:#374151;margin-bottom:20px;}
.password-fields{display:flex;flex-direction:column;gap:18px;}
.password-fields input{
  width:100%;padding:12px;border:1px solid var(--line);border-radius:8px;outline:none;transition:border-color 0.15s, background 0.15s;
}
.password-fields input:focus{border-color:var(--primary);}
.input-error {
  border: 2px solid #ef4444 !important;
  background: #fff5f5 !important;
  box-shadow: 0 0 6px rgba(239,68,68,0.3);
}
.pw-error{font-size:13px;color:#ef4444;margin-top:4px;display:none;}
/* íšŒì› íƒˆí‡´ */
.leave-box{border-top:1px solid var(--line);margin-top:50px;padding-top:40px;}
.leave-box h3{font-size:18px;font-weight:700;margin-bottom:20px;}
.notice-box{background:#f8fafc;border:1px solid var(--line);border-radius:8px;padding:15px 20px;font-size:13px;color:#374151;margin-bottom:15px;line-height:1.6;}
.leave-confirm{display:flex;align-items:center;gap:8px;margin-top:10px;}
.leave-btn{
  margin-top:20px;align-self:flex-end;background:#f3f4f6;color:#111;border:1px solid #d1d5db;
  padding:10px 20px;border-radius:8px;cursor:pointer;font-size:15px;transition:all 0.25s ease;
}
.leave-btn:disabled{background:#e5e7eb;color:#9ca3af;border-color:#d1d5db;cursor:not-allowed;}
.leave-btn.active{background:var(--primary);color:#fff;border-color:var(--primary);}
.leave-btn.active:hover{background:#0044cc;border-color:#0044cc;color:#fff;}
.leave-confirm input[type="checkbox"]{
  -webkit-appearance:none;-moz-appearance:none;appearance:none;width:18px;height:18px;border:2px solid var(--line);
  border-radius:4px;cursor:pointer;background:#fff;transition:all 0.2s ease;
}
.leave-confirm input[type="checkbox"]:hover{border-color:var(--primary);}
.leave-confirm input[type="checkbox"]:checked{background:var(--primary);border-color:var(--primary);}
.leave-confirm input[type="checkbox"]:checked::after{
  content:"âœ”";color:#fff;font-size:13px;font-weight:bold;position:absolute;margin-left:2px;margin-top:-1px;
}
.leave-confirm label{cursor:pointer;user-select:none;color:var(--text-dark);}
/* í† ìŠ¤íŠ¸ */
.alert-box-custom{
  position:fixed;top:40px;right:40px;background:var(--white);border:1px solid var(--primary);
  box-shadow:0 8px 20px rgba(0,86,255,0.15);border-radius:12px;padding:16px 26px;
  font-size:15px;font-weight:500;color:var(--primary);opacity:0;transform:translateY(-10px);
  pointer-events:none;transition:all 0.4s ease;z-index:1000;
}
.alert-box-custom.show{opacity:1;transform:translateY(0);}
.alert-box-custom.error{border-color:#ef4444;color:#ef4444;box-shadow:0 8px 20px rgba(239,68,68,0.15);}

/* ëª¨ë‹¬ */
.confirm-modal {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.45); display: none; align-items: center; justify-content: center;
  z-index: 2000; animation: fadeIn 0.3s ease;
}
.confirm-content {
  background: var(--white); padding: 35px 40px; border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: center;
  max-width: 420px; width: 90%; animation: popIn 0.25s ease;
}
.confirm-content h4 {font-size: 20px; font-weight: 700; margin-bottom: 10px;}
.confirm-content p {font-size: 14px; color: var(--text-gray); line-height: 1.6; margin-bottom: 25px;}
.confirm-actions {display: flex; justify-content: center; gap: 12px;}
.confirm-btn, .cancel-btn {
  padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;
  font-size: 15px; font-weight: 500; transition: 0.25s;
}
.cancel-btn {background: #f3f4f6; color: #111827; border: 1px solid #d1d5db;}
.cancel-btn:hover {background: #e5e7eb;}
.confirm-btn {background: var(--primary); color: #fff;}
.confirm-btn:hover {background: #0044cc;}
/* í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´ */
.profile-menu-container {
  position: relative;
  display: inline-block;
}
.profile-dropdown {
  display: none;
  position: absolute;
  right: 0;
  top: 50px;
  background: var(--white);
  border: 1px solid var(--line);
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  min-width: 160px;
  overflow: hidden;
  z-index: 1000;
}
.profile-dropdown a {
  display: block;
  padding: 12px 16px;
  font-size: 14px;
  color: var(--text-dark);
  text-decoration: none;
  transition: background 0.2s;
}
.profile-dropdown a:hover {
  background: #f3f6ff;
  color: var(--primary);
}
</style>
</head>

<body>
<header>
  <div class="logo" onclick="location.href='index.html'">BlueOn</div>

  <div class="profile-menu-container">
    <img id="headerAvatar" src="assets/default_profile.png" alt="í”„ë¡œí•„ ì•„ì´ì½˜" />
    <div id="profileDropdown" class="profile-dropdown">
      <a href="profile-edit.html">í”„ë¡œí•„ ì„¤ì •</a>
      <a href="expert-register-step1.html">ì„œë¹„ìŠ¤ ë“±ë¡</a>
      <a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
  </div>
</header>

<main class="profile-layout">
  <aside class="sidebar"><h3>í”„ë¡œí•„ ê´€ë¦¬</h3></aside>
  <section class="content">
    <h2>ê¸°ë³¸ ì •ë³´</h2>

    <form id="profileForm" enctype="multipart/form-data">
      <div class="profile-area">
        <div class="profile-left">
          <img id="preview" src="assets/default_profile.png" alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
          <input type="file" id="avatar" name="avatar" accept="image/*" style="display:none;">
          <button type="button" id="changeAvatarBtn">í”„ë¡œí•„ ë³€ê²½</button>
        </div>

        <div class="profile-right">
          <div class="nickname-section">
            <label>ë‹‰ë„¤ì„</label>
            <div class="nickname-input">
              
              <input type="text" id="nickname" name="nickname" maxlength="17" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.">

              <small id="nickname-status" style="font-size:13px; margin-top:4px;"></small>
               
              <span id="char-count">0/17</span>
            </div>

            <div id="nickname-status"></div>
          </div>

          <div class="tip-box">
            TIP: ë‹‰ë„¤ì„ì€ 30ì¼ë§ˆë‹¤ í•œ ë²ˆë§Œ ë³€ê²½ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>

          <div class="textarea-section">
            <label>ìê¸°ì†Œê°œ</label>
            <textarea id="intro" name="intro" placeholder="ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœëŒ€ 255ì)"></textarea>
            <small id="intro-count">0/255</small>
          </div>
        </div>
      </div>

      <button type="submit" class="change-btn" style="margin-top:30px;">í”„ë¡œí•„ ì €ì¥</button>
    </form>

    <div class="password-box">
      <h3>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
      <div class="alert-box">ëŒ€ë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.</div>
      <form id="passwordForm" class="password-fields" novalidate>
        <div class="pw-group">
          <input type="password" id="currentPassword" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" required>
          <small class="pw-error" id="error-current"></small>
        </div>
        <div class="pw-group">
          <input type="password" id="newPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" required>
          <small class="pw-error" id="error-new"></small>
        </div>
        <div class="pw-group">
          <input type="password" id="confirmPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" required>
          <small class="pw-error" id="error-confirm"></small>
        </div>
        <button type="submit" class="change-btn">ë³€ê²½í•˜ê¸°</button>
      </form>
    </div>

    <div class="leave-box">
      <h3>íšŒì› íƒˆí‡´</h3>
      <div class="notice-box">íƒˆí‡´ ì‹œ ëª¨ë“  ì„œë¹„ìŠ¤ ì´ìš© ê¸°ë¡ì´ ì‚­ì œë˜ë©°, ë³µêµ¬ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</div>

      <div class="leave-confirm">
        <input type="checkbox" id="agree"><label for="agree">ì•ˆë‚´ ì‚¬í•­ì„ ëª¨ë‘ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤.</label>
      </div>

      <button id="deleteBtn" class="leave-btn">íšŒì› íƒˆí‡´</button>
    </div>
  </section>
</main>

<div id="confirmModal" class="confirm-modal">
  <div class="confirm-content">
    <h4>ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h4>
    <p>íƒˆí‡´ í›„ì—ëŠ” ê³„ì • ë° ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ë©° ë³µêµ¬ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
    <div class="confirm-actions">
      <button id="cancelDelete" class="cancel-btn">ì·¨ì†Œ</button>
      <button id="confirmDelete" class="confirm-btn">íƒˆí‡´í•˜ê¸°</button>
    </div>
  </div>
</div>

<div id="toast" class="alert-box-custom"></div>

<script>
const API_URL = "http://localhost:3000";

function toast(msg,isError=false){
  const box=document.getElementById("toast");
  if(!box)return;
  box.textContent=msg;
  box.className=`alert-box-custom ${isError?"error":""} show`;
  setTimeout(()=>box.classList.remove("show"),2500);
}

/* í”„ë¡œí•„ ì´ë¯¸ì§€ */
const avatarInput=document.getElementById("avatar");
const preview=document.getElementById("preview");
const changeBtn=document.getElementById("changeAvatarBtn");
const profileForm=document.getElementById("profileForm");
const headerAvatar=document.getElementById("headerAvatar");
const nicknameInput=document.getElementById("nickname");
const introInput=document.getElementById("intro");
const charCnt=document.getElementById("char-count");
const introCnt=document.getElementById("intro-count");
const nicknameStatusBox=document.getElementById("nickname-status");

if(changeBtn) changeBtn.addEventListener("click",()=>avatarInput.click());
if(avatarInput) avatarInput.addEventListener("change",(e)=>{
  const f=e.target.files?.[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    preview.src=ev.target.result;
    headerAvatar.src=ev.target.result;
  };
  r.readAsDataURL(f);
});

if(nicknameInput) nicknameInput.addEventListener("input",()=>charCnt.textContent=`${nicknameInput.value.length}/17`);
if(introInput) introInput.addEventListener("input",()=>introCnt.textContent=`${introInput.value.length}/255`);

/* ==========================================================
   ìƒíƒœ ë³€ìˆ˜
========================================================== */
let nicknameValid = false;
let currentUserNickname = "";   // /me ë¶ˆëŸ¬ì˜¬ ë•Œ ì±„ì›Œì§
let nicknameTimer = null;       // debounce íƒ€ì´ë¨¸

/* ==========================================================
   í”„ë¡œí•„ ì €ì¥
========================================================== */
if (profileForm) {
  profileForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!nicknameValid) {
      toast("ë‹‰ë„¤ì„ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.", true);
      return;
    }

    const fd = new FormData(profileForm);

    try {
      const res = await fetch(`${API_URL}/profile/update`, {
        method: "POST",
        body: fd,
        credentials: "include",
      });

      const data = await res.json();

      if (data.success) {
        toast("í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤ âœ…");

        if (data.user?.avatar_url) {
          headerAvatar.src = data.user.avatar_url;
        }

        setTimeout(() => (window.location.href = "profile.html"), 1500);
      } else {
        toast(data.message || "í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨", true);
      }
    } catch (err) {
      console.error("âŒ í”„ë¡œí•„ ì €ì¥ ì˜¤ë¥˜:", err);
      toast("ì„œë²„ ì˜¤ë¥˜", true);
    }
  });
}

/* ==========================================================
   ì„œë²„ ì¤‘ë³µ ì²´í¬ (availableë§Œ ì‚¬ìš©)
========================================================== */
async function checkNicknameDuplicate(nickname) {
  try {
    const res = await fetch(
      `${API_URL}/expert/check-nickname?nickname=${encodeURIComponent(
        nickname
      )}`
    );
    const data = await res.json();

    if (!data.success) return false;

    // ì„œë²„ëŠ” available = true/falseë§Œ ì‚¬ìš©
    return data.available;
  } catch (err) {
    console.error("ë‹‰ë„¤ì„ ì²´í¬ ì˜¤ë¥˜:", err);
    return false;
  }
}

/* ==========================================================
   ë‹‰ë„¤ì„ ì…ë ¥ ì‹œ ì¤‘ë³µ ê²€ì‚¬ (ìµœì¢… ì•ˆì •í™” ë²„ì „)
   - debounce 400ms ì ìš©
   - ë³¸ì¸ ë‹‰ë„¤ì„ ì¦‰ì‹œ OK
   - ê¹œë¹¡ì„/ì¶©ëŒ 0%
========================================================== */
nicknameInput.addEventListener("input", () => {
  const nickname = nicknameInput.value.trim();

  // ê¸€ì ìˆ˜ í‘œì‹œ
  charCnt.textContent = `${nickname.length}/17`;

  // ì…ë ¥ ë¹„ì—ˆì„ ë•Œ
  if (!nickname) {
    nicknameStatusBox.textContent = "";
    nicknameValid = false;
    return;
  }

  // ğŸ”µ ë³¸ì¸ ë‹‰ë„¤ì„ì´ë©´ ì„œë²„ì—ê²Œ ê°€ì§€ ì•ŠìŒ
  if (nickname === currentUserNickname) {
    nicknameStatusBox.style.color = "#16a34a";
    nicknameStatusBox.textContent = "í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.";
    nicknameValid = true;
    return;
  }

  // ğŸ”´ ì…ë ¥ ì¤‘ì¼ ë•Œ ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
  clearTimeout(nicknameTimer);

  // 0.4ì´ˆ ë™ì•ˆ ì…ë ¥ ë©ˆì¶”ë©´ ë”± í•œ ë²ˆ ê²€ì‚¬
  nicknameTimer = setTimeout(async () => {
    const available = await checkNicknameDuplicate(nickname);

    if (!available) {
      nicknameStatusBox.style.color = "#ef4444";
      nicknameStatusBox.textContent = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.";
      nicknameValid = false;
    } else {
      nicknameStatusBox.style.color = "#16a34a";
      nicknameStatusBox.textContent = "ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.";
      nicknameValid = true;
    }
  }, 400);
});

/* ==========================================================
   ì´ˆê¸° ìœ ì € ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° (/me)
========================================================== */
window.addEventListener("DOMContentLoaded", async () => {
  try {
    const res = await fetch(`${API_URL}/me`, { credentials: "include" });
    const data = await res.json();

    if (data.success && data.user) {
      // í˜„ì¬ ë‹‰ë„¤ì„ ì €ì¥ â†’ ë³¸ì¸ ë‹‰ë„¤ì„ ì˜ˆì™¸ ì²˜ë¦¬ì— í•„ìš”
      currentUserNickname = data.user.nickname || "";

      // ê¸°ë³¸ ì…ë ¥ê°’ ì„¸íŒ…
      nicknameInput.value = currentUserNickname;
      introInput.value = data.user.intro || "";

      charCnt.textContent = `${currentUserNickname.length}/17`;
      introCnt.textContent = `${introInput.value.length}/255`;

      if (data.user.avatar_url) {
        preview.src = data.user.avatar_url;
        headerAvatar.src = data.user.avatar_url;
      }
    }
  } catch (e) {
    console.error("í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
  }
});


/* ========================= (ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ) ======================= */
/* ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ */
const passwordForm=document.getElementById("passwordForm");
const currentPw=document.getElementById("currentPassword");
const newPw=document.getElementById("newPassword");
const confirmPw=document.getElementById("confirmPassword");
const errorCurrent=document.getElementById("error-current");
const errorNew=document.getElementById("error-new");
const errorConfirm=document.getElementById("error-confirm");

function validatePassword(pw){
  return /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*]).{8,}$/.test(pw);
}

function setErr(el,msgEl,msg){el.classList.add("input-error");msgEl.textContent=msg;msgEl.style.display="block";}
function clearErr(el,msgEl){el.classList.remove("input-error");msgEl.textContent="";msgEl.style.display="none";}

[currentPw,newPw,confirmPw].forEach(input=>{
  input.addEventListener("input",()=>{
    const v=input.value.trim();
    const errBox=input===currentPw?errorCurrent:input===newPw?errorNew:errorConfirm;

    if(v.length>0 && !validateField(input,v)){
      setErr(input,errBox,getErrorMessage(input));
    }else if(validateField(input,v)){
      clearErr(input,errBox);
    }
  });
});

function validateField(input,val){
  if(input===newPw) return validatePassword(val);
  if(input===confirmPw) return val===newPw.value.trim();
  if(input===currentPw) return true;
  return true;
}
function getErrorMessage(input){
  if(input===newPw) return "ëŒ€ë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
  if(input===confirmPw) return "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
  if(input===currentPw) return "í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
  return "ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
}

let pwCheckTimer;
async function verifyCurrentPassword(){
  const val=currentPw.value.trim();
  if(!val){
    clearErr(currentPw,errorCurrent);
    return;
  }
  try{
    const res=await fetch(`${API_URL}/profile/check-password`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      credentials:"include",
      body:JSON.stringify({currentPassword:val})
    });
    const data=await res.json();

    if(!data.valid){
      setErr(currentPw,errorCurrent,"í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }else clearErr(currentPw,errorCurrent);
  }catch(err){
    console.error("ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ ì˜¤ë¥˜:",err);
  }
}
currentPw.addEventListener("input",()=>{
  clearTimeout(pwCheckTimer);
  pwCheckTimer=setTimeout(()=>verifyCurrentPassword(),600);
});
currentPw.addEventListener("blur",()=>{
  clearTimeout(pwCheckTimer);
  verifyCurrentPassword();
});

if(passwordForm){
  passwordForm.addEventListener("submit",async(e)=>{
    e.preventDefault();
    const cur=currentPw.value.trim(), np=newPw.value.trim(), cp=confirmPw.value.trim();
    let err=false;

    if(!cur){setErr(currentPw,errorCurrent,"í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");err=true;}
    if(!validatePassword(np)){setErr(newPw,errorNew,getErrorMessage(newPw));err=true;}
    if(cp!==np){setErr(confirmPw,errorConfirm,getErrorMessage(confirmPw));err=true;}

    if(err){toast("ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.",true);return;}

    try{
      const res=await fetch(`${API_URL}/profile/change-password`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body:JSON.stringify({currentPassword:cur,newPassword:np})
      });
      const data=await res.json();

      if(data.success){
        toast("ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        [currentPw,newPw,confirmPw].forEach(i=>i.value="");
      }else{
        if(data.message.includes("í˜„ì¬")) setErr(currentPw,errorCurrent,"í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        else toast("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨",true);
      }
    }catch{
      toast("ì„œë²„ ì˜¤ë¥˜",true);
    }
  });
}

/* íšŒì›íƒˆí‡´ */
const agree=document.getElementById("agree");
const delBtn=document.getElementById("deleteBtn");
const modal=document.getElementById("confirmModal");
const cancelDelete=document.getElementById("cancelDelete");
const confirmDelete=document.getElementById("confirmDelete");

delBtn.disabled=true;
agree.addEventListener("change",()=>{
  delBtn.disabled=!agree.checked;
  delBtn.classList.toggle("active",agree.checked);
});
delBtn.addEventListener("click",()=>{
  if(!agree.checked) return toast("ì•ˆë‚´ì‚¬í•­ì— ë™ì˜í•´ì£¼ì„¸ìš”.",true);
  modal.style.display="flex";
});
cancelDelete.addEventListener("click",()=>modal.style.display="none");

confirmDelete.addEventListener("click",async()=>{
  try{
    const res=await fetch(`${API_URL}/profile/delete`,{method:"POST",credentials:"include"});
    const data=await res.json();
    if(data.success){
      toast("íšŒì› íƒˆí‡´ ì™„ë£Œ");
      setTimeout(()=>location.href="index.html",1500);
    }else toast("íšŒì› íƒˆí‡´ ì‹¤íŒ¨",true);
  }catch{
    toast("ì„œë²„ ì˜¤ë¥˜",true);
  }
});

/* ìœ ì € ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° */
window.addEventListener("DOMContentLoaded",async()=>{
  try{
    const res=await fetch(`${API_URL}/me`,{credentials:"include"});
    const data=await res.json();
    if(data.success && data.user){
      if(data.user.avatar_url){
        preview.src=data.user.avatar_url;
        headerAvatar.src=data.user.avatar_url;
      }
      nicknameInput.value=data.user.nickname || "";
      introInput.value=data.user.intro || "";
      charCnt.textContent=`${nicknameInput.value.length}/17`;
      introCnt.textContent=`${introInput.value.length}/255`;
    }
    currentUserNickname = data.user.nickname; // ğŸ”µ í˜„ì¬ ì‚¬ìš©ì ë‹‰ë„¤ì„ ì €ì¥

  }catch(e){
    console.error("í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨",e);
  }
});

/* í”„ë¡œí•„ ë“œë¡­ë‹¤ìš´ */
const headerAvatarImg=document.getElementById("headerAvatar");
const dropdown=document.getElementById("profileDropdown");
headerAvatarImg.addEventListener("click",()=>{
  dropdown.style.display=dropdown.style.display==="block"?"none":"block";
});
document.addEventListener("click",e=>{
  if(!e.target.closest(".profile-menu-container")) dropdown.style.display="none";
});

/* ì „ë¬¸ê°€ ì—¬ë¶€ ë©”ë‰´ ìë™ë³€ê²½ */
async function loadUserState(){
  try{
    const res=await fetch(`${API_URL}/expert/is-registered`,{credentials:"include"});
    const data=await res.json();

    if(data.isExpert){
      dropdown.innerHTML=`
        <a href="expert-profile.html">ì „ë¬¸ê°€ í”„ë¡œí•„</a>
        <a href="expert-register-step1.html">ì„œë¹„ìŠ¤ ë“±ë¡</a>
        <a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
      `;
    }else{
      dropdown.innerHTML=`
        <a href="profile-edit.html">í”„ë¡œí•„ ì„¤ì •</a>
        <a href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
        <a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
      `;
    }
  }catch(err){
    console.error("ìœ ì € ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨",err);
  }
}
loadUserState();

/* ë¡œê·¸ì•„ì›ƒ */
document.addEventListener("click",async(e)=>{
  if(e.target.id==="logoutBtn"){
    await fetch(`${API_URL}/logout`,{method:"POST",credentials:"include"});
    location.href="index.html";
  }
});
</script>


</body>
</html>
