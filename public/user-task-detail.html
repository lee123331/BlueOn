<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BlueOn | ì‘ì—… ìƒì„¸</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#0056ff;
      --bg:#f4f6fb;
      --white:#ffffff;
      --line:#e5e7eb;
      --text:#111827;
      --gray:#6b7280;
      --soft:#eef4ff;
      --good:#16a34a;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Noto Sans KR", sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      background:#fff;
      border-bottom:1px solid var(--line);
      padding:16px 60px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position:sticky;
      top:0;
      z-index:10;
    }
    .logo{
      font-size:22px;
      font-weight:800;
      color:var(--primary);
      cursor:pointer;
    }
    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      color:#111;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition:.2s;
      display:inline-flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
    }
    .btn:hover{border-color:var(--primary); color:var(--primary); background:var(--soft)}
    .btn-primary{
      border:1px solid var(--primary);
      background:var(--primary);
      color:#fff;
    }
    .btn-primary:hover{filter:brightness(.95); background:var(--primary); color:#fff}
    .btn[disabled]{
      opacity:.55;
      cursor:not-allowed;
      filter:grayscale(30%);
    }

    .container{
      max-width:1100px;
      margin:30px auto;
      padding:0 20px 80px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:18px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      header{padding:16px 18px}
    }

    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:18px;
    }

    /* ìƒë‹¨ ìš”ì•½ */
    .summary{
      display:flex;
      gap:16px;
      align-items:center;
    }
    .thumb{
      width:92px;
      height:92px;
      border-radius:14px;
      border:1px solid var(--line);
      object-fit:cover;
      background:#eef2ff;
      flex:0 0 auto;
    }
    .sum-info{
      flex:1;
      min-width:0;
    }
    .title{
      font-weight:900;
      font-size:20px;
      line-height:1.25;
      margin-bottom:8px;
      word-break:keep-all;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px 16px;
      color:var(--gray);
      font-size:14px;
      align-items:center;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid var(--line);
      background:#fff;
      color:#111;
    }
    .pill.primary{border-color:#cfe0ff; background:#eef4ff; color:var(--primary)}
    .pill.good{border-color:#cdeed7; background:#ecfdf3; color:var(--good)}
    .pill.warn{border-color:#fde7c4; background:#fffbeb; color:var(--warn)}

    /* ì„¹ì…˜ íƒ€ì´í‹€ */
    .sec-title{
      font-weight:900;
      font-size:16px;
      margin-bottom:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sec-title small{
      font-weight:700;
      color:var(--gray);
    }

    /* ì •ë³´ ë¦¬ìŠ¤íŠ¸ */
    .info-list{
      display:grid;
      grid-template-columns: 130px 1fr;
      gap:10px 12px;
      font-size:14px;
    }
    .label{color:var(--gray); font-weight:800}
    .value{font-weight:700; word-break:break-word}

    /* ë¹ˆ ë‚´ìš© */
    .empty{
      padding:18px;
      background:#fafbff;
      border:1px dashed #dbe6ff;
      border-radius:14px;
      color:#6b7280;
      font-weight:700;
      line-height:1.6;
    }

    /* í•˜ë‹¨ ê³ ì • ì•¡ì…˜(ëª¨ë°”ì¼ ëŠë‚Œ) */
    .action-bar{
      margin-top:16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .action-bar .btn{
      flex:1;
      justify-content:center;
      min-width:200px;
    }

    /* ë¡œë”© */
    .loading{
      padding:24px;
      color:var(--gray);
      font-weight:800;
    }
  </style>
</head>

<body>

<header>
  <div class="logo" onclick="location.href='index.html'">BlueOn</div>
  <div class="top-actions">
    <a class="btn" href="my-orders.html">â† ë‚´ ì‘ì—… í˜„í™©</a>
  </div>
</header>

<div class="container">
  <div id="loading" class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

  <div id="content" style="display:none;">
    <div class="grid">

      <!-- ì¢Œì¸¡: ìš”ì•½ + ìš”ì²­ì‚¬í•­ -->
      <div class="card">
        <div class="summary">
          <img id="thumb" class="thumb" src="/assets/default_service.png" alt="ì„œë¹„ìŠ¤ ì¸ë„¤ì¼">
          <div class="sum-info">
            <div id="serviceTitle" class="title">-</div>
            <div class="meta">
              <span id="statusPill" class="pill primary">-</span>
              <span class="pill" id="expertPill">ì „ë¬¸ê°€: -</span>
              <span class="pill" id="orderPill">ì£¼ë¬¸ë²ˆí˜¸: -</span>
            </div>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="sec-title">
          <span>ìš”ì²­ ì •ë³´</span>
          <small id="createdAt">-</small>
        </div>

        <div id="requestBox" class="empty">
          ìš”ì²­ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>

        <div class="action-bar">
          <button id="chatBtn" class="btn btn-primary">ğŸ’¬ ì±„íŒ…ìœ¼ë¡œ ì´ë™</button>
          <button id="refreshBtn" class="btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>

      <!-- ìš°ì¸¡: ìƒì„¸ ì •ë³´ -->
      <div class="card">
        <div class="sec-title">
          <span>ìƒì„¸ ì •ë³´</span>
          <small id="taskKeyText">taskKey: -</small>
        </div>

        <div class="info-list" style="margin-bottom:14px;">
          <div class="label">ìƒíƒœ</div>
          <div class="value" id="statusText">-</div>

          <div class="label">ì „ë¬¸ê°€ ë‹‰ë„¤ì„</div>
          <div class="value" id="expertNickname">-</div>

          <div class="label">ì§„í–‰ ë‹¨ê³„</div>
          <div class="value" id="phaseText">-</div>

          <div class="label">ì„œë¹„ìŠ¤</div>
          <div class="value" id="serviceText">-</div>
        </div>

        <div class="sec-title">
          <span>ì•ˆë‚´</span>
        </div>
        <div class="empty" id="guideBox">
          ì§„í–‰ì¤‘ ìƒíƒœì—ì„œëŠ” ì±„íŒ…ìœ¼ë¡œ ì‘ì—…ì„ ì§„í–‰í•  ìˆ˜ ìˆì–´ìš”.<br>
          ì™„ë£Œ ìƒíƒœì—ì„œëŠ” ê²°ê³¼ë¬¼ì„ í™•ì¸í•œ ë’¤ í•„ìš”í•œ ê²½ìš° ì¶”ê°€ ìš”ì²­ì„ ë‚¨ê¸¸ ìˆ˜ ìˆì–´ìš”.
        </div>
      </div>

    </div>
  </div>
</div>

<script>
const API = "https://blueon.up.railway.app";
const taskKey = new URLSearchParams(location.search).get("task");

if (!taskKey) {
  alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. (task ëˆ„ë½)");
  location.href = "my-orders.html";
}

/* ======================================================
   ìœ ì € ê¸°ì¤€ ìƒíƒœ ë§¤í•‘/í‘œì‹œ
====================================================== */
function mapUserStatus(status) {
  if (status === "progress") return "progress";
  if (status === "done") return "done";
  return "pending"; // start/ready/pending ë“±
}

function statusLabel(userStatus) {
  if (userStatus === "pending") return "ì‘ì—… ì¤€ë¹„ì¤‘";
  if (userStatus === "progress") return "ì§„í–‰ì¤‘";
  return "ì‘ì—… ì™„ë£Œ";
}

function pillClass(userStatus) {
  if (userStatus === "pending") return "pill warn";
  if (userStatus === "progress") return "pill primary";
  return "pill good";
}

/* ======================================================
   ìƒì„¸ ë¶ˆëŸ¬ì˜¤ê¸° (ì—¬ëŸ¬ ì—”ë“œí¬ì¸íŠ¸ fallback)
   - ë„¤ ì„œë²„ê°€ ì–´ë–¤ ë¼ìš°íŠ¸ë¥¼ ì“°ëŠ”ì§€ 100% í™•ì •ì´ ì•„ë‹ˆë¼ì„œ
     "í•œ ë²ˆì— ì„±ê³µí•˜ëŠ” êµ¬ì¡°"ë¡œ ì•ˆì „í•˜ê²Œ í•´ë‘ .
====================================================== */
async function fetchDetailByTaskKey(taskKey) {
  const candidates = [
    `${API}/my/tasks/detail?taskKey=${encodeURIComponent(taskKey)}`,
    `${API}/tasks/detail?taskKey=${encodeURIComponent(taskKey)}`,
    `${API}/user/tasks/detail?taskKey=${encodeURIComponent(taskKey)}`,
    `${API}/orders/detail?taskKey=${encodeURIComponent(taskKey)}`
  ];

  for (const url of candidates) {
    try {
      const res = await fetch(url, { credentials:"include" });
      const data = await res.json();
      if (data && data.success) return { data, used:url };
    } catch (e) {}
  }
  return null;
}

/* ======================================================
   ë Œë”
====================================================== */
function safe(v, fallback="-") {
  if (v === null || v === undefined || v === "") return fallback;
  return v;
}

function render(detail) {
  // detail.data ë‚´ë¶€ êµ¬ì¡°ê°€ ì„œë²„ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆì–´
  // ê°€ì¥ í”í•œ í‚¤ë“¤ë¡œ í¡ìˆ˜ ì²˜ë¦¬
  const d = detail.data;

  const row = d.task || d.order || d.detail || d.data || d; // ìµœëŒ€í•œ í¡ìˆ˜
  const serviceTitle = row.service_title || row.title || row.serviceName;
  const thumbnail = row.thumbnail || row.service_thumbnail || row.thumb;
  const expertNickname = row.expert_nickname || row.expertNickname || row.expert_name;
  const statusRaw = row.status || row.task_status;
  const userStatus = mapUserStatus(statusRaw);

  const createdAt = row.created_at || row.createdAt || row.ordered_at || row.order_created_at;
  const phase = row.phase || row.task_phase || row.main_category || row.category;

  const orderId = row.order_id || row.id || row.orderId;
  const requestText =
    row.request_message ||
    row.requirements ||
    row.user_request ||
    row.message ||
    "";

  // DOM
  document.getElementById("thumb").src = thumbnail || "/assets/default_service.png";
  document.getElementById("serviceTitle").innerText = safe(serviceTitle, "ì„œë¹„ìŠ¤");
  document.getElementById("expertNickname").innerText = safe(expertNickname, "ì „ë¬¸ê°€");
  document.getElementById("expertPill").innerText = `ì „ë¬¸ê°€: ${safe(expertNickname, "ì „ë¬¸ê°€")}`;
  document.getElementById("orderPill").innerText = `ì£¼ë¬¸ë²ˆí˜¸: ${safe(orderId, "-")}`;
  document.getElementById("taskKeyText").innerText = `taskKey: ${taskKey}`;

  // ìƒíƒœ
  const label = statusLabel(userStatus);
  const pill = document.getElementById("statusPill");
  pill.className = pillClass(userStatus);
  pill.innerText = label;
  document.getElementById("statusText").innerText = `${label} (${safe(statusRaw,"-")})`;

  // ë‹¨ê³„/ì„œë¹„ìŠ¤
  document.getElementById("phaseText").innerText = safe(phase, "-");
  document.getElementById("serviceText").innerText = safe(serviceTitle, "-");

  // ë‚ ì§œ
  document.getElementById("createdAt").innerText = createdAt ? formatDate(createdAt) : "-";

  // ìš”ì²­ì‚¬í•­
  const box = document.getElementById("requestBox");
  if (requestText && String(requestText).trim().length > 0) {
    box.className = "";
    box.style.padding = "0";
    box.style.border = "0";
    box.style.background = "transparent";
    box.innerHTML = `
      <div style="
        padding:18px;
        border:1px solid var(--line);
        border-radius:14px;
        background:#fafbff;
        line-height:1.7;
        font-weight:700;
        color:#111827;
        white-space:pre-line;
      ">${escapeHtml(String(requestText).trim())}</div>
    `;
  } else {
    box.className = "empty";
    box.innerHTML = `ìš”ì²­ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.`;
  }

  // ì±„íŒ… ë²„íŠ¼ ìƒíƒœ
  const chatBtn = document.getElementById("chatBtn");
  if (userStatus === "pending") {
    chatBtn.disabled = true;
    chatBtn.innerText = "â³ ì „ë¬¸ê°€ ì‘ì—… ì‹œì‘ ëŒ€ê¸°ì¤‘";
  } else {
    chatBtn.disabled = false;
    chatBtn.innerText = "ğŸ’¬ ì±„íŒ…ìœ¼ë¡œ ì´ë™";
  }
}

/* ======================================================
   ìœ í‹¸
====================================================== */
function formatDate(dateString) {
  const d = new Date(dateString);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

function escapeHtml(str) {
  return str
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ======================================================
   ì´ˆê¸° ì‹¤í–‰
====================================================== */
async function init() {
  document.getElementById("loading").style.display = "block";
  document.getElementById("content").style.display = "none";

  const detail = await fetchDetailByTaskKey(taskKey);

  if (!detail) {
    alert("ì‘ì—… ìƒì„¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (API ë¼ìš°íŠ¸ í™•ì¸ í•„ìš”)");
    location.href = "my-orders.html";
    return;
  }

  render(detail);

  document.getElementById("loading").style.display = "none";
  document.getElementById("content").style.display = "block";
}

document.getElementById("refreshBtn").onclick = () => init();

document.getElementById("chatBtn").onclick = () => {
  // ë„¤ê°€ ë§Œë“  task ê¸°ì¤€ ì±„íŒ… í˜ì´ì§€ë¡œ ë³´ë‚´ê¸°
  location.href = `task-chat.html?taskKey=${encodeURIComponent(taskKey)}`;
};

init();
</script>

</body>
</html>
